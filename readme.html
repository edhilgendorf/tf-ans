<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-08-24 Tue 19:36 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Deploying a Web App with AWS, Terraform, Cloud-init, Ansible and Jenkins</title>
<meta name="author" content="edward" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Deploying a Web App with AWS, Terraform, Cloud-init, Ansible and Jenkins</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgf5e9859">1. The project</a>
<ul>
<li><a href="#org1fc6af6">1.1. This Document</a></li>
</ul>
</li>
<li><a href="#org9dffffb">2. Conventions</a>
<ul>
<li><a href="#orge5de61f">2.1. syntax</a></li>
<li><a href="#org59f2ead">2.2. Code Example</a></li>
</ul>
</li>
<li><a href="#org5957320">3. Install Terraform&#xa0;&#xa0;&#xa0;<span class="tag"><span class="terraform">terraform</span>&#xa0;<span class="install">install</span></span></a></li>
<li><a href="#org16e080f">4. Install Packer &#x2013; (Unused in this project, at this time)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="packer">packer</span>&#xa0;<span class="install">install</span></span></a></li>
<li><a href="#org9eec447">5. Configure AWS&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aws">aws</span></span></a>
<ul>
<li><a href="#org3ae44a9">5.1. Setup AWS CLI&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cli">cli</span>&#xa0;<span class="install">install</span></span></a></li>
<li><a href="#org9751e59">5.2. Create IAM User and Policies&#xa0;&#xa0;&#xa0;<span class="tag"><span class="iam">iam</span></span></a></li>
</ul>
</li>
<li><a href="#org66e5566">6. Configure Terraform Cloud</a>
<ul>
<li><a href="#org8612b04">6.1. Setup Terraform Cloud State</a></li>
</ul>
</li>
<li><a href="#orgf8e1d5b">7. Create Infrastructure with Terraform&#xa0;&#xa0;&#xa0;<span class="tag"><span class="terraform">terraform</span>&#xa0;<span class="iac">iac</span></span></a>
<ul>
<li><a href="#orgb2d7dad">7.1. Create variables&#xa0;&#xa0;&#xa0;<span class="tag"><span class="variables">variables</span></span></a></li>
<li><a href="#org14f7546">7.2. Create a network&#xa0;&#xa0;&#xa0;<span class="tag"><span class="network">network</span></span></a></li>
<li><a href="#orga0d41c4">7.3. Create Instances</a></li>
</ul>
</li>
<li><a href="#orgc24e987">8. Bootstrap EC2 with cloud-init&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cloudinit">cloudinit</span></span></a></li>
</ul>
</div>
</div>
<div id="outline-container-orgf5e9859" class="outline-2">
<h2 id="orgf5e9859"><span class="section-number-2">1</span> The project</h2>
<div class="outline-text-2" id="text-1">
<p>
Project is to use this repository ( and possibly a couple others ) to build and deploy a web application using some core technologies:
</p>
<ul class="org-ul">
<li>AWS for cloud housting</li>
<li>Terraform to provision AWS</li>
<li>Cloud-init for any VMs</li>
<li>Ansible for config management</li>
<li>Jenkins to deploy the application</li>
<li>An application <i>(TBD)</i></li>
</ul>
</div>
<div id="outline-container-org1fc6af6" class="outline-3">
<h3 id="org1fc6af6"><span class="section-number-3">1.1</span> This Document</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Documentation and code are built into this same <a href="https://orgmode.org/">orgmode</a> document. All the code in this repository is created from snippets in this document via org-tangle. The process is as follows:
</p>
<ol class="org-ol">
<li>Create a new bullet point/update old one</li>
<li>Add <code>PROPERTIES</code> under the bullet to specify file to either ammend or create</li>
<li>Run <code>org-bable-tangle</code> (within Emacs). This extracts all code blocks and builds code files</li>
<li><i>optional</i> Apply any necessary formatting, ex: <code>terraform fmt</code></li>
<li>Check in and push changes. This document and corresponding repositories <b>should</b> be VCS driven, with changes applied after successful Git commit/push.</li>
</ol>
<p>
The purpose of this is to build a cloud based project using IaC that explains <b>why</b> each step is done, as well as <b>how</b>, all in one place.
</p>
</div>
</div>
</div>
<div id="outline-container-org9dffffb" class="outline-2">
<h2 id="org9dffffb"><span class="section-number-2">2</span> Conventions</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orge5de61f" class="outline-3">
<h3 id="orge5de61f"><span class="section-number-3">2.1</span> syntax</h3>
<div class="outline-text-3" id="text-2-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">type</th>
<th scope="col" class="org-left">example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>custom input</code></td>
<td class="org-left"><code>&lt;your_input&gt;</code></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org59f2ead" class="outline-3">
<h3 id="org59f2ead"><span class="section-number-3">2.2</span> Code Example</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>Each block will be named as above</li>
<li>Following will be bullet points with an explanation and <i>hopefully</i> a link to the corresponding resource</li>
</ul>
</div>
<div id="outline-container-orgab063b0" class="outline-4">
<h4 id="orgab063b0"><span class="section-number-4">2.2.1</span> <a href="./example_code.py">./example_code.py</a> &lt;&#x2013; the file that will be &ldquo;tangled&rdquo;, see <a href="#org1fc6af6">This Document</a></h4>
<div class="outline-text-4" id="text-2-2-1">
<ul class="org-ul">
<li><p>
This prints &ldquo;hello world&rdquo; to the user on execution
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #51afef;">print</span> (<span style="color: #98be65;">"hello world"</span>)
</pre>
</div></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-org5957320" class="outline-2">
<h2 id="org5957320"><span class="section-number-2">3</span> Install Terraform&#xa0;&#xa0;&#xa0;<span class="tag"><span class="terraform">terraform</span>&#xa0;<span class="install">install</span></span></h2>
<div class="outline-text-2" id="text-3">
<p>
<a href="https://www.terraform.io/downloads.html">https://www.terraform.io/downloads.html</a>
</p>
</div>
</div>
<div id="outline-container-org16e080f" class="outline-2">
<h2 id="org16e080f"><span class="section-number-2">4</span> Install Packer &#x2013; (Unused in this project, at this time)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="packer">packer</span>&#xa0;<span class="install">install</span></span></h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">curl</span> -fsSL https://apt.releases.hashicorp.com/gpg | <span style="color: #ECBE7B;">sudo</span> apt-key add -
<span style="color: #ECBE7B;">sudo</span> apt-add-repository <span style="color: #98be65;">"deb [arch=amd64] https://apt.releases.hashicorp.com </span><span style="color: #51afef; font-weight: bold;">$(</span><span style="color: #51afef; font-weight: bold;">lsb_release</span><span style="color: #51afef; font-weight: bold;"> -cs)</span><span style="color: #98be65;"> main"</span>
<span style="color: #ECBE7B;">sudo</span> apt-get update &amp;&amp; <span style="color: #ECBE7B;">sudo</span> apt-get install packer
</pre>
</div>
</div>
</div>
<div id="outline-container-org9eec447" class="outline-2">
<h2 id="org9eec447"><span class="section-number-2">5</span> Configure AWS&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aws">aws</span></span></h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>Register account: <a href="https://portal.aws.amazon.com/gp/aws/developer/registration/index.html">https://portal.aws.amazon.com/gp/aws/developer/registration/index.html</a></li>
</ul>
</div>
<div id="outline-container-org3ae44a9" class="outline-3">
<h3 id="org3ae44a9"><span class="section-number-3">5.1</span> Setup AWS CLI&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cli">cli</span>&#xa0;<span class="install">install</span></span></h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-linux.html">https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-linux.html</a></li>
</ul>
</div>
</div>
<div id="outline-container-org9751e59" class="outline-3">
<h3 id="org9751e59"><span class="section-number-3">5.2</span> Create IAM User and Policies&#xa0;&#xa0;&#xa0;<span class="tag"><span class="iam">iam</span></span></h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>IAM: <a href="https://console.aws.amazon.com/iam/home">https://console.aws.amazon.com/iam/home</a></li>
<li>Polcies: <a href="https://console.aws.amazon.com/iamv2/home?#/policiesC">https://console.aws.amazon.com/iamv2/home?#/policiesC</a></li>
<li>IAM User: <a href="https://console.aws.amazon.com/iam/home#/users$new?step=details">https://console.aws.amazon.com/iam/home#/users$new?step=details</a>
<ul class="org-ul">
<li>programmatic (non-console)</li>
<li>attach existing policy</li>
</ul></li>
<li><p>
Add user to <code>/.aws/credentials</code> as a profile:
</p>
<pre class="example">
 [default]
 aws_access_key=&lt;your_key&gt;
 aws_secret_access_key=&lt;your_key&gt;

 [tf_user]
 aws_access_key=&lt;your_key&gt;
 aws_secret_access_key=&lt;your_key&gt;
</pre></li>
<li>Add root user as default, or create IAM admin:
<a href="https://console.aws.amazon.com/iam/home?region=us-east-1#/security_credentials$access_key">https://console.aws.amazon.com/iam/home?region=us-east-1#/security_credentials$access_key</a></li>
</ul>
</div>
<div id="outline-container-orgf7eebb8" class="outline-4">
<h4 id="orgf7eebb8"><span class="section-number-4">5.2.1</span> attach a base policy&#xa0;&#xa0;&#xa0;<span class="tag"><span class="policy">policy</span></span></h4>
<div class="outline-text-4" id="text-5-2-1">
<p>
<a href="./policies/base.json">./policies/base.json</a>
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org66e5566" class="outline-2">
<h2 id="org66e5566"><span class="section-number-2">6</span> Configure Terraform Cloud</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li>Regsiter account: <a href="https://app.terraform.io/signup/account?utm_source=terraform_io&amp;utm_content=terraform_cloud_top_nav">https://app.terraform.io/signup/account?utm_source=terraform_io&amp;utm_content=terraform_cloud_top_nav</a></li>
</ul>
</div>
<div id="outline-container-org8612b04" class="outline-3">
<h3 id="org8612b04"><span class="section-number-3">6.1</span> Setup Terraform Cloud State</h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li>Create an organization</li>
<li>Create a Workspace from VCS Repository, ex: <a href="https://github.com">https://github.com</a></li>
<li>Create a token and save in <code>~/.terraform.d/credentials.tfrc.json</code>
<ul class="org-ul">
<li><a href="https://app.terraform.io/app/settings/tokens">https://app.terraform.io/app/settings/tokens</a></li>
</ul></li>
<li><p>
Create Terraform Backend config locally:
</p>
<div class="org-src-container">
<pre class="src src-json">  terraform {
    backend "remote" {
      organization = "&lt;your_org&gt;"
      workspaces {
        name ="&lt;your_workspace&gt;"
      }
    }
  }
</pre>
</div></li>
<li>Add access keys to Terraform Cloud
<ul class="org-ul">
<li><a href="https://app.terraform.io/app/">https://app.terraform.io/app/</a>&lt;organization&gt;/workspaces/&lt;workspace&gt;/variables</li>
</ul></li>
<li>Initialize your environment <code>terraform init</code></li>
<li>Configure Terraform Cloud to plan and apply upon check-in
<ul class="org-ul">
<li><a href="https://app.terraform.io/app/">https://app.terraform.io/app/</a>&lt;your<sub>org</sub>&gt;/workspaces/&lt;your<sub>workspace</sub>&gt;/settings/general</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgf8e1d5b" class="outline-2">
<h2 id="orgf8e1d5b"><span class="section-number-2">7</span> Create Infrastructure with Terraform&#xa0;&#xa0;&#xa0;<span class="tag"><span class="terraform">terraform</span>&#xa0;<span class="iac">iac</span></span></h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-orgb2d7dad" class="outline-3">
<h3 id="orgb2d7dad"><span class="section-number-3">7.1</span> Create variables&#xa0;&#xa0;&#xa0;<span class="tag"><span class="variables">variables</span></span></h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li>Input variables serve as parameters for a Terraform module, allowing aspects of the module to be customized without altering the module&rsquo;s own source code, and allowing modules to be shared between different configurations.
<ul class="org-ul">
<li><a href="https://www.terraform.io/docs/language/values/variables.html">https://www.terraform.io/docs/language/values/variables.html</a></li>
</ul></li>
</ul>
</div>
<div id="outline-container-org2c036c9" class="outline-4">
<h4 id="org2c036c9"><span class="section-number-4">7.1.1</span> <a href="./variables.tf">./variables.tf</a></h4>
<div class="outline-text-4" id="text-7-1-1">
<ul class="org-ul">
<li>profile and default user</li>
<li>two regions
<ul class="org-ul">
<li>a master region</li>
<li>a worker region</li>
</ul></li>
<li>external_<sub>ip</sub> (yours)</li>
<li>workers<sub>count</sub> (how many instances to create)</li>
<li>instance type when deploying EC2</li>
</ul>
<div class="org-src-container">
<pre class="src src-js">variable <span style="color: #98be65;">"profile"</span> {
  type    = string
  <span style="color: #51afef;">default</span> = <span style="color: #98be65;">"tf_user"</span>
}
variable <span style="color: #98be65;">"region-master"</span> {
  type    = string
  <span style="color: #51afef;">default</span> = <span style="color: #98be65;">"us-east-1"</span>
}
variable <span style="color: #98be65;">"region-worker"</span> {
  type    = string
  <span style="color: #51afef;">default</span> = <span style="color: #98be65;">"us-west-2"</span>
}
variable <span style="color: #98be65;">"test"</span> {
  type    = string
  <span style="color: #51afef;">default</span> = <span style="color: #98be65;">"catheadbiscuit"</span>
}
#Replace <span style="color: #51afef;">with</span> &lt;YOUR_EXTERNAL_IP&gt;  https:<span style="color: #5B6268;">//</span><span style="color: #5B6268;">ipv4.icanhazip.com</span>
variable <span style="color: #98be65;">"external_ip"</span> {
  type    = string
  <span style="color: #51afef;">default</span> = <span style="color: #98be65;">"0.0.0.0/0"</span>
}
variable <span style="color: #98be65;">"workers-count"</span> {
  type    = number
  <span style="color: #51afef;">default</span> = <span style="color: #da8548; font-weight: bold;">1</span>
}
variable <span style="color: #98be65;">"instance-type"</span> {
  type    = string
  <span style="color: #51afef;">default</span> = <span style="color: #98be65;">"t3.micro"</span>
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org14f7546" class="outline-3">
<h3 id="org14f7546"><span class="section-number-3">7.2</span> Create a network&#xa0;&#xa0;&#xa0;<span class="tag"><span class="network">network</span></span></h3>
<div class="outline-text-3" id="text-7-2">
</div>
<div id="outline-container-org5b134b6" class="outline-4">
<h4 id="org5b134b6"><span class="section-number-4">7.2.1</span> Create VPCs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="vpc">vpc</span></span></h4>
<div class="outline-text-4" id="text-7-2-1">
<ul class="org-ul">
<li>A virtual network dedicated to your AWS account.
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html">https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html</a></li>
</ul></li>
</ul>
</div>
<ol class="org-ol">
<li><a id="orga01e840"></a><a href="./network.tf">./network.tf</a><br />
<div class="outline-text-5" id="text-7-2-1-1">
<ul class="org-ul">
<li>VPCs
<ul class="org-ul">
<li><b>vpc<sub>master</sub></b>
<ul class="org-ul">
<li>deploy in us-east-1</li>
<li>give network 10.0.0.0/16</li>
<li>enable dns and hostnames</li>
<li>tag this as <code>master-vpc-jenkins</code></li>
</ul></li>
<li><b>vpc<sub>master</sub><sub>oregon</sub></b>
<ul class="org-ul">
<li>deploy in us-west-2</li>
<li>give network 192.168.0.0/16</li>
<li>enable dns and hostnames</li>
<li>tag as <code>worker-vpc-jenkins</code></li>
</ul></li>
</ul></li>
<li>Variables come from: <a href="#orgb2d7dad">Create variables</a></li>
</ul>
<div class="org-src-container">
<pre class="src src-js">#Create VPC <span style="color: #51afef;">in</span> us-east-<span style="color: #da8548; font-weight: bold;">1</span>
resource <span style="color: #98be65;">"aws_vpc"</span> <span style="color: #98be65;">"vpc_master"</span> {
  provider             = aws.region-master
  cidr_block           = <span style="color: #98be65;">"10.0.0.0/16"</span>
  enable_dns_support   = <span style="color: #a9a1e1;">true</span>
  enable_dns_hostnames = <span style="color: #a9a1e1;">true</span>
  tags = {
    Name = <span style="color: #98be65;">"master-vpc-jenkins"</span>
  }
}
#Create VPC <span style="color: #51afef;">in</span> us-west-<span style="color: #da8548; font-weight: bold;">2</span>
resource <span style="color: #98be65;">"aws_vpc"</span> <span style="color: #98be65;">"vpc_master_oregon"</span> {
  provider             = aws.region-worker
  cidr_block           = <span style="color: #98be65;">"192.168.0.0/16"</span>
  enable_dns_support   = <span style="color: #a9a1e1;">true</span>
  enable_dns_hostnames = <span style="color: #a9a1e1;">true</span>
  tags = {
    Name = <span style="color: #98be65;">"worker-vpc-jenkins"</span>
  }
}
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgfbb262c" class="outline-4">
<h4 id="orgfbb262c"><span class="section-number-4">7.2.2</span> Create IGWs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="igw">igw</span></span></h4>
<div class="outline-text-4" id="text-7-2-2">
<ul class="org-ul">
<li>An internet gateway is a horizontally scaled, redundant, and highly available VPC component that allows communication between your VPC and the internet.
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Internet_Gateway.html">https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Internet_Gateway.html</a></li>
</ul></li>
<li><a href="./network.tf">./network.tf</a>
<ul class="org-ul">
<li>create an internet gateway in each VPC, which reside in different availability zones (us-east-1 and us-west-2)</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgaab3e48" class="outline-4">
<h4 id="orgaab3e48"><span class="section-number-4">7.2.3</span> Provide Data&#xa0;&#xa0;&#xa0;<span class="tag"><span class="data">data</span></span></h4>
<div class="outline-text-4" id="text-7-2-3">
<ul class="org-ul">
<li>Data sources allow Terraform use information defined outside of Terraform, defined by another separate Terraform configuration, or modified by functions.
<ul class="org-ul">
<li><a href="https://www.terraform.io/docs/language/data-sources/index.html">https://www.terraform.io/docs/language/data-sources/index.html</a></li>
</ul></li>
<li><a href="./network.tf">./network.tf</a>
<ul class="org-ul">
<li>get <code>aws_availability_zones</code> that are in <code>state: available</code></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org20f3a83" class="outline-4">
<h4 id="org20f3a83"><span class="section-number-4">7.2.4</span> Create Subnets in our VPCs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="subnet">subnet</span></span></h4>
<div class="outline-text-4" id="text-7-2-4">
<ul class="org-ul">
<li>When you create a VPC, you must specify a range of IPv4 addresses for the VPC in the form of a Classless Inter-Domain Routing (CIDR) block; for example, 10.0.0.0/16. This is the primary CIDR block for your VPC. For more information about CIDR notation, see RFC 4632.
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html">https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html</a></li>
</ul></li>
<li><a href="./network.tf">./network.tf</a>
<ul class="org-ul">
<li>two subnets in the master VPC defined in <a href="#org5b134b6">Create VPCs</a>.
<ul class="org-ul">
<li><code>10.0.1.0/24</code></li>
<li><code>10.0.2.0/24</code></li>
</ul></li>
<li>one subnet in the worker VPC defined in  <a href="#org5b134b6">Create VPCs</a>.
<ul class="org-ul">
<li><code>192.168.1.0/24</code></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgce3f061" class="outline-4">
<h4 id="orgce3f061"><span class="section-number-4">7.2.5</span> Create Peering between VPCs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="peering">peering</span></span></h4>
<div class="outline-text-4" id="text-7-2-5">
<ul class="org-ul">
<li>A VPC peering connection is a networking connection between two VPCs that enables you to route traffic between them using private IPv4 addresses or IPv6 addresses.
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/vpc/latest/peering/what-is-vpc-peering.html">https://docs.aws.amazon.com/vpc/latest/peering/what-is-vpc-peering.html</a></li>
</ul></li>
<li><a href="./network.tf">./network.tf</a>
<ul class="org-ul">
<li>Create a peering connection request from the master VPC.</li>
<li>Create a peering connection acceptor from the worker VPC.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgbf812c6" class="outline-4">
<h4 id="orgbf812c6"><span class="section-number-4">7.2.6</span> Create Routing in and between VPCs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="route">route</span>&#xa0;<span class="vpc">vpc</span></span></h4>
<div class="outline-text-4" id="text-7-2-6">
<ul class="org-ul">
<li>A route table contains a set of rules, called routes, that are used to determine where network traffic from your subnet or gateway is directed.
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Route_Tables.html">https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Route_Tables.html</a></li>
</ul></li>
<li><a href="./network.tf">./network.tf</a>
<ul class="org-ul">
<li>create a routing table for the master VPC
<ul class="org-ul">
<li>to internet via <code>aws_internet_gateway.igw.id</code></li>
<li>to the worker VPC Peering Connection created in:  <a href="#orgce3f061">Create Peering between VPCs</a></li>
</ul></li>
<li>replace default route of the master VPC with the routing table created above</li>
<li>create routing table for worker VPC
<ul class="org-ul">
<li>to internet via <code>aws_internet_gateway.igw.id</code></li>
<li>to the master VPC Peering Connection created in:  <a href="#orgce3f061">Create Peering between VPCs</a></li>
</ul></li>
<li>replace default route of the worker VPC with the routing table created above</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org31be156" class="outline-4">
<h4 id="org31be156"><span class="section-number-4">7.2.7</span> Create Security Groups&#xa0;&#xa0;&#xa0;<span class="tag"><span class="security_groups">security_groups</span></span></h4>
<div class="outline-text-4" id="text-7-2-7">
<ul class="org-ul">
<li>A security group acts as a virtual firewall for your instance to control inbound and outbound traffic.
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html">https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html</a></li>
</ul></li>
<li><a href="./security_groups.tf">./security_groups.tf</a>
<ul class="org-ul">
<li>create a SG for the: <a href="#org04bfde2">Create an ALB</a>
<ul class="org-ul">
<li>allow in from 80/443 web ports.</li>
<li>allow out anywhere for ephemeral ports.</li>
</ul></li>
<li>create a security group for Jenkins in VPC Master
<ul class="org-ul">
<li>allow in from 80/443 web ports.</li>
<li>allow out anywhere for ephemeral ports.</li>
<li>allow ssh from port 22 from our home IP</li>
<li>allow in from us-west-2 (worker) subnet created in  <a href="#org20f3a83">Create Subnets in our VPCs</a></li>
</ul></li>
<li>create a security group for Jenkins in VPC worker
<ul class="org-ul">
<li>allow in from 80/443 web ports.</li>
<li>allow out anywhere for ephemeral ports.</li>
<li>allow ssh from port 22 from our home IP</li>
<li>allow in from us-east-1 (master) subnet created in  <a href="#org20f3a83">Create Subnets in our VPCs</a></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org04bfde2" class="outline-4">
<h4 id="org04bfde2"><span class="section-number-4">7.2.8</span> Create an ALB&#xa0;&#xa0;&#xa0;<span class="tag"><span class="alb">alb</span></span></h4>
</div>
</div>
<div id="outline-container-orga0d41c4" class="outline-3">
<h3 id="orga0d41c4"><span class="section-number-3">7.3</span> Create Instances</h3>
<div class="outline-text-3" id="text-7-3">
</div>
<div id="outline-container-org8fbe557" class="outline-4">
<h4 id="org8fbe557"><span class="section-number-4">7.3.1</span> Configure AMIs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ami">ami</span>&#xa0;<span class="vm">vm</span></span></h4>
<div class="outline-text-4" id="text-7-3-1">
<ul class="org-ul">
<li>An Amazon Machine Image (AMI) provides the information required to launch an instance.
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html</a></li>
</ul></li>
<li><a href="./instances.tf">./instances.tf</a>
<ul class="org-ul">
<li>data
<ul class="org-ul">
<li>get the AMI names for the latest Amazon Linux AMI</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orge743097" class="outline-4">
<h4 id="orge743097"><span class="section-number-4">7.3.2</span> Configure SSH keypairs for AMI VMs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="keypair">keypair</span></span></h4>
<div class="outline-text-4" id="text-7-3-2">
<ul class="org-ul">
<li>A key pair, consisting of a public key and a private key, is a set of security credentials that you use to prove your identity when connecting to an Amazon EC2 instance. Amazon EC2 stores the public key on your instance, and you store the private key. For Linux instances, the private key allows you to securely SSH into your instance. Anyone who possesses your private key can connect to your instances, so it&rsquo;s important that you store your private key in a secure place.
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html</a></li>
</ul></li>
<li><a href="./instances.tf">./instances.tf</a>
<ul class="org-ul">
<li>create keypairs for each region</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org8f99523" class="outline-4">
<h4 id="org8f99523"><span class="section-number-4">7.3.3</span> Bootstrap EC2 Instances with cloud-init&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ansible">ansible</span>&#xa0;<span class="ec2">ec2</span></span></h4>
<div class="outline-text-4" id="text-7-3-3">
<ul class="org-ul">
<li><a href="https://cloudinit.readthedocs.io/en/latest/topics/examples.html">https://cloudinit.readthedocs.io/en/latest/topics/examples.html</a></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc24e987" class="outline-2">
<h2 id="orgc24e987"><span class="section-number-2">8</span> Bootstrap EC2 with cloud-init&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cloudinit">cloudinit</span></span></h2>
<div class="outline-text-2" id="text-8">
<ul class="org-ul">
<li><a href="https://cloudinit.readthedocs.io/en/latest/">https://cloudinit.readthedocs.io/en/latest/</a></li>
<li><a href="./cloud-init.yaml">./cloud-init.yaml</a>
<ul class="org-ul">
<li>install software</li>
<li>create users</li>
<li>jenkins-master will also be ansible master</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: edward</p>
<p class="date">Created: 2021-08-24 Tue 19:36</p>
</div>
</body>
</html>
