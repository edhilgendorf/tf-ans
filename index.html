<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-10-12 Tue 16:12 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Deploying a Web App with AWS, Terraform, Cloud-init, Ansible and Jenkins</title>
<meta name="author" content="edward" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Deploying a Web App with AWS, Terraform, Cloud-init, Ansible and Jenkins</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgd68565e">1. The project</a>
<ul>
<li><a href="#orgbdfbf27">1.1. Technologies used/steps</a>
<ul>
<li><a href="#org6b0eb70">1.1.1. <span class="done DONE">DONE</span> AWS for cloud housting</a></li>
<li><a href="#orgac48dc8">1.1.2. <span class="done DONE">DONE</span> GitHub to host code, configs, and static site: https://edhilgendorf.github.io/tf-ans/</a></li>
<li><a href="#org278fd9a">1.1.3. <span class="done DONE">DONE</span> Terraform Cloud ( free ) to handle state and Terrafrom deployments upon check-in with GitHub</a></li>
<li><a href="#org0c224cc">1.1.4. Terraform to provision AWS</a></li>
<li><a href="#orga018d81">1.1.5. <span class="todo TODO">TODO</span> Cloud-init for any VMs</a></li>
<li><a href="#orgbf1a458">1.1.6. Ansible for config management, hosted on</a></li>
<li><a href="#org0b6f260">1.1.7. Jenkins to deploy the application ECS for AWX</a></li>
</ul>
</li>
<li><a href="#orgbadf6e7">1.2. This Document</a></li>
<li><a href="#orgfd8a3eb">1.3. Links</a></li>
<li><a href="#org97c8fae">1.4. Challenges</a></li>
<li><a href="#org3cd3617">1.5. Conventions&#xa0;&#xa0;&#xa0;<span class="tag"><span class="conventions">conventions</span></span></a>
<ul>
<li><a href="#org548f7ad">1.5.1. Code Example</a></li>
<li><a href="#org266f6ea">1.5.2. File structure</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org42ff60f">2. Install Terraform&#xa0;&#xa0;&#xa0;<span class="tag"><span class="terraform">terraform</span>&#xa0;<span class="install">install</span></span></a></li>
<li><a href="#org49485aa">3. Install Packer &#x2013; (Unused in this project, at this time)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="packer">packer</span>&#xa0;<span class="install">install</span></span></a></li>
<li><a href="#orgf7ac4ff">4. Configure AWS&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aws">aws</span></span></a>
<ul>
<li><a href="#orgfc102e1">4.1. Setup AWS CLI&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cli">cli</span>&#xa0;<span class="install">install</span></span></a></li>
<li><a href="#org4255609">4.2. Use AWS CLI&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cli">cli</span></span></a></li>
<li><a href="#-configure-aws-create-iam-user-and-policies-">4.3. Create IAM User and Policies&#xa0;&#xa0;&#xa0;<span class="tag"><span class="iam">iam</span></span></a>
<ul>
<li><a href="#org680318c">4.3.1. IAM Terraform User <span class="underline">start</span>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="policy">policy</span></span></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org40af7ed">5. Configure Terraform Cloud&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cloud">cloud</span>&#xa0;<span class="terraform_cloud">terraform_cloud</span></span></a>
<ul>
<li><a href="#orga0c1132">5.1. ./terraform/backend.tf</a></li>
</ul>
</li>
<li><a href="#-create-infrastructure-with-terraform-">6. Create Infrastructure with Terraform&#xa0;&#xa0;&#xa0;<span class="tag"><span class="terraform">terraform</span>&#xa0;<span class="iac">iac</span></span></a>
<ul>
<li><a href="#org0c02e78">6.1. Configure Providers</a>
<ul>
<li><a href="#org63c9229">6.1.1. ./terraform/providers.tf</a></li>
</ul>
</li>
<li><a href="#org22a2152">6.2. Create variables&#xa0;&#xa0;&#xa0;<span class="tag"><span class="variables">variables</span></span></a>
<ul>
<li><a href="#orge3cb1c9">6.2.1. ./terraform/variables.tf</a></li>
</ul>
</li>
<li><a href="#org9998023">6.3. Create a network&#xa0;&#xa0;&#xa0;<span class="tag"><span class="network">network</span></span></a>
<ul>
<li><a href="#org7263c86">6.3.1. Create VPCs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="vpc">vpc</span></span></a></li>
<li><a href="#org40f1aa6">6.3.2. Create IGWs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="igw">igw</span></span></a></li>
<li><a href="#orgd6580f6">6.3.3. Provide Data&#xa0;&#xa0;&#xa0;<span class="tag"><span class="data">data</span></span></a></li>
<li><a href="#org5c46a18">6.3.4. Create Subnets in our VPCs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="subnet">subnet</span></span></a></li>
<li><a href="#org3e3ef58">6.3.5. Create Peering between VPCs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="peering">peering</span></span></a></li>
<li><a href="#org6c1efe2">6.3.6. Create Routing in and between VPCs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="route">route</span>&#xa0;<span class="vpc">vpc</span></span></a></li>
<li><a href="#org02f0909">6.3.7. Create Security Groups&#xa0;&#xa0;&#xa0;<span class="tag"><span class="security_groups">security_groups</span></span></a></li>
</ul>
</li>
<li><a href="#orge72d2a5">6.4. Create IAM Role for EC2 Access&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ec2">ec2</span>&#xa0;<span class="iam">iam</span></span></a>
<ul>
<li><a href="#org9d855b8">6.4.1. ./terraform/iam.tf&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aws_iam_role">aws_iam_role</span></span></a></li>
<li><a href="#orgb73ba76">6.4.2. ./terraform/iam.tf&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aws_iam_instance_profile">aws_iam_instance_profile</span></span></a></li>
<li><a href="#org0a4a01f">6.4.3. ./terraform/iam.tf&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aws_iam_role_policy">aws_iam_role_policy</span></span></a></li>
</ul>
</li>
<li><a href="#orge00f99d">6.5. Create Instances</a>
<ul>
<li><a href="#org58d0f3b">6.5.1. Get AMIs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ami">ami</span>&#xa0;<span class="vm">vm</span></span></a></li>
<li><a href="#orgfc3d56d">6.5.2. Set cloud-init Scripts</a></li>
<li><a href="#org72efbb0">6.5.3. Configure SSH keypairs for AMI VMs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="keypair">keypair</span></span></a></li>
<li><a href="#org0947e7f">6.5.4. Create EC2 Instances&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ec2">ec2</span></span></a></li>
</ul>
</li>
<li><a href="#-create-infrastructure-with-terraform-s3-">6.6. S3&#xa0;&#xa0;&#xa0;<span class="tag"><span class="s3">s3</span></span></a>
<ul>
<li><a href="#org38c889a">6.6.1. ./terraform/s3.tf&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aws_s3">aws_s3</span></span></a></li>
</ul>
</li>
<li><a href="#org5cbfaa9">6.7. Create EFS&#xa0;&#xa0;&#xa0;<span class="tag"><span class="efs">efs</span></span></a>
<ul>
<li><a href="#org54d1ffc">6.7.1. ./terraform/efs.tf</a></li>
</ul>
</li>
<li><a href="#-create-infrastructure-with-terraform-ecs-for-awx-">6.8. ECS for AWX&#xa0;&#xa0;&#xa0;<span class="tag"><span class="awx">awx</span>&#xa0;<span class="ecs">ecs</span></span></a>
<ul>
<li><a href="#org78580b2">6.8.1. ./terraform/ecs.tf</a></li>
</ul>
</li>
<li><a href="#org3bec491">6.9. Create Outputs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="output">output</span></span></a>
<ul>
<li><a href="#orgddeaf1d">6.9.1. ./terraform/outputs.tf&#xa0;&#xa0;&#xa0;<span class="tag"><span class="outputs">outputs</span></span></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org413d071">7. Bootstrap EC2 with cloud-init&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cloud_init">cloud_init</span></span></a>
<ul>
<li><a href="#orgd40da37">7.1. ./terraform/scripts/cloud-init.yaml&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cloudinit">cloudinit</span>&#xa0;<span class="script">script</span></span></a></li>
<li><a href="#org1049a0d">7.2. ./terraform/scripts/cloud-init.yaml&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cloudinit">cloudinit</span>&#xa0;<span class="script">script</span></span></a></li>
</ul>
</li>
<li><a href="#org40fa15b">8. Configuration Management with Ansible&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ansible">ansible</span></span></a>
<ul>
<li><a href="#orgc902780">8.1. <del>Getting AWS Credentials to Ansible</del> This is best configured by attaching a role to the EC2 instance, done here: Create IAM Role for EC2 Access</a>
<ul>
<li><a href="#orgbc4eb52">8.1.1. ./terraform/sync-aws-creds.sh</a></li>
</ul>
</li>
<li><a href="#org187efda">8.2. Dynamic Inventory&#xa0;&#xa0;&#xa0;<span class="tag"><span class="dynamic_inventory">dynamic_inventory</span></span></a>
<ul>
<li><a href="#orga0eb763">8.2.1. ../ansible-cloud/ansible.cfg</a></li>
<li><a href="#org0ab71f4">8.2.2. ../ansible-cloud/aws_ec2.yml</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#-iam-terraform-user--end--">9. IAM Terraform User <span class="underline">end</span>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="policy_end">policy_end</span></span></a></li>
<li><a href="#org8e84a1a">10. Useful Commands</a></li>
<li><a href="#org0aa524b">11. Troubleshooting&#xa0;&#xa0;&#xa0;<span class="tag"><span class="troubleshooting">troubleshooting</span></span></a>
<ul>
<li><a href="#org1d729cc">11.1. Encoded Messages&#xa0;&#xa0;&#xa0;<span class="tag"><span class="sts">sts</span>&#xa0;<span class="error">error</span></span></a></li>
<li><a href="#org9f96f6e">11.2. Unrelated Errors&#xa0;&#xa0;&#xa0;<span class="tag"><span class="error">error</span>&#xa0;<span class="region">region</span></span></a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
See: <a href="https://edhilgendorf.github.io/tf-ans/">https://edhilgendorf.github.io/tf-ans/</a>
</p>
<div id="outline-container-orgd68565e" class="outline-2">
<h2 id="orgd68565e"><span class="section-number-2">1</span> The project</h2>
<div class="outline-text-2" id="text-1">
<p>
Project is to use this repository ( and possibly a couple others ) to build and deploy a web application using some core technologies:
</p>
</div>
<div id="outline-container-orgbdfbf27" class="outline-3">
<h3 id="orgbdfbf27"><span class="section-number-3">1.1</span> Technologies used/steps</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org6b0eb70" class="outline-4">
<h4 id="org6b0eb70"><span class="section-number-4">1.1.1</span> <span class="done DONE">DONE</span> AWS for cloud housting</h4>
<div class="outline-text-4" id="text-1-1-1">
<ul class="org-ul">
<li><a href="#orgf7ac4ff">Configure AWS</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgac48dc8" class="outline-4">
<h4 id="orgac48dc8"><span class="section-number-4">1.1.2</span> <span class="done DONE">DONE</span> GitHub to host code, configs, and static site: <a href="https://edhilgendorf.github.io/tf-ans/">https://edhilgendorf.github.io/tf-ans/</a></h4>
</div>
<div id="outline-container-org278fd9a" class="outline-4">
<h4 id="org278fd9a"><span class="section-number-4">1.1.3</span> <span class="done DONE">DONE</span> Terraform Cloud ( free ) to handle state and Terrafrom deployments upon check-in with GitHub</h4>
<div class="outline-text-4" id="text-1-1-3">
<ul class="org-ul">
<li><a href="#org40af7ed">Configure Terraform Cloud</a></li>
</ul>
</div>
</div>
<div id="outline-container-org0c224cc" class="outline-4">
<h4 id="org0c224cc"><span class="section-number-4">1.1.4</span> Terraform to provision AWS</h4>
<div class="outline-text-4" id="text-1-1-4">
<ul class="org-ul">
<li><a href="#-create-infrastructure-with-terraform-">Create Infrastructure with Terraform</a></li>
</ul>
</div>
</div>
<div id="outline-container-orga018d81" class="outline-4">
<h4 id="orga018d81"><span class="section-number-4">1.1.5</span> <span class="todo TODO">TODO</span> Cloud-init for any VMs</h4>
<div class="outline-text-4" id="text-1-1-5">
<ul class="org-ul">
<li><a href="#org413d071">Bootstrap EC2 with cloud-init</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgbf1a458" class="outline-4">
<h4 id="orgbf1a458"><span class="section-number-4">1.1.6</span> Ansible for config management, hosted on</h4>
<div class="outline-text-4" id="text-1-1-6">
<ul class="org-ul">
<li><a href="#org40fa15b">Configuration Management with Ansible</a> on <a href="#-create-infrastructure-with-terraform-ecs-for-awx-">ECS for AWX</a></li>
</ul>
</div>
</div>
<div id="outline-container-org0b6f260" class="outline-4">
<h4 id="org0b6f260"><span class="section-number-4">1.1.7</span> Jenkins to deploy the application <a href="#-create-infrastructure-with-terraform-ecs-for-awx-">ECS for AWX</a></h4>
<div class="outline-text-4" id="text-1-1-7">
<ul class="org-ul">
<li>An application <i>(TBD)</i> inside a Docker Container</li>
<li>Ansible to Deploy Kubernetes</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgbadf6e7" class="outline-3">
<h3 id="orgbadf6e7"><span class="section-number-3">1.2</span> This Document</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Documentation and code are built into this same <a href="https://orgmode.org/">orgmode</a> document. All the code in this repository is created from snippets in this document via org-tangle. The process is as follows:
</p>
<ol class="org-ol">
<li>Create a new bullet point/update old one</li>
<li>Add <code>PROPERTIES</code> under the bullet to specify file to either ammend or create</li>
<li>Run <code>org-bable-tangle</code> (within Emacs). This extracts all code blocks and builds code files</li>
<li><i>optional</i> Apply any necessary formatting, ex: <code>terraform fmt</code></li>
<li>Check in and push changes. This document and corresponding repositories <b>should</b> be VCS driven, with changes applied after successful Git commit/push.</li>
</ol>
<p>
The purpose of this is to build a cloud based project using IaC that explains <b>why</b> each step is done, as well as <b>how</b>, all in one place. See this document in plain text, here: <a href="https://raw.githubusercontent.com/edhilgendorf/tf-ans/main/readme.org">readme.org</a>
</p>
</div>
</div>
<div id="outline-container-orgfd8a3eb" class="outline-3">
<h3 id="orgfd8a3eb"><span class="section-number-3">1.3</span> Links</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li><a href="https://github.com/edhilgendorf/tf-ans">Terraform Project Repository</a></li>
<li><a href="https://github.com/edhilgendorf/ansible-cloud">Ansible Project Repository</a></li>
<li><a href="https://edhilgendorf.github.io/tf-ans/">Read the docs</a></li>
<li><a href="https://hilgendorf.me">hilgendorf.me</a></li>
</ul>
</div>
</div>
<div id="outline-container-org97c8fae" class="outline-3">
<h3 id="org97c8fae"><span class="section-number-3">1.4</span> Challenges</h3>
<div class="outline-text-3" id="text-1-4">
<dl class="org-dl">
<dt>Secrets</dt><dd>The idea is this entire document and project are available so anyone can see how it is setup and the output at the end. This means no plaintext passwords and having to be carefeul with key-pairs.</dd>
<dt>VCS Driven from Terraform Cloud</dt><dd>This has been the most difficult. I have seen before, and do not want to end up with a situation where you have to run Bash/etc scripts from different locations to get to the required end-state, so I decided to use VCS as &ldquo;single source of truth&rdquo; and have all Terraform deployed from Terraform Cloud. This rules out a lot of things: using Terraform outputs in Ansible/etc scripts, as well as using local provisioners. That being said, Terraform recommends against local-exec provisioners so I think it&rsquo;s a good step, regardless.</dd>
</dl>
</div>
</div>
<div id="outline-container-org3cd3617" class="outline-3">
<h3 id="org3cd3617"><span class="section-number-3">1.5</span> Conventions&#xa0;&#xa0;&#xa0;<span class="tag"><span class="conventions">conventions</span></span></h3>
<div class="outline-text-3" id="text-1-5">
</div>
<div id="outline-container-org548f7ad" class="outline-4">
<h4 id="org548f7ad"><span class="section-number-4">1.5.1</span> Code Example</h4>
<div class="outline-text-4" id="text-1-5-1">
<ul class="org-ul">
<li>Each block will be named as above</li>
<li>Following will be bullet points with an explanation and <i>hopefully</i> a link to the corresponding resource</li>
</ul>
</div>
<ol class="org-ol">
<li><a id="org458eead"></a><a href="./terraform/example_code.py">./terraform/example_code.py</a> &lt;&#x2013; the file that will be &ldquo;tangled&rdquo;, see <a href="#orgbadf6e7">This Document</a><br />
<div class="outline-text-5" id="text-1-5-1-1">
<ul class="org-ul">
<li><p>
This prints &ldquo;hello world&rdquo; to the user on execution
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #51afef;">print</span> (<span style="color: #98be65;">"hello world"</span>)
<span style="color: #51afef;">print</span>(<span style="color: #98be65;">"1"</span>)
</pre>
</div></li>
</ul>
</div>
</li>
</ol>
</div>
<div id="outline-container-org266f6ea" class="outline-4">
<h4 id="org266f6ea"><span class="section-number-4">1.5.2</span> File structure</h4>
<div class="outline-text-4" id="text-1-5-2">
<ul class="org-ul">
<li>Since Terraform runs are repo driven, anytime an update hits it will queue up a run. In order to save money on AWS, and lower the number of runs, create a working directory in Terraform Cloud, then relocate all Terraform code to that directory.
<ul class="org-ul">
<li><a href="https://www.terraform.io/docs/cloud/workspaces/settings.html">https://www.terraform.io/docs/cloud/workspaces/settings.html</a></li>
</ul></li>
<li>It is then possible to trigger runs only on working directories</li>
<li>This also prevents Terraform kicking off when I am only updating this documentation.</li>
<li><p>
Real file structure will look like this:
</p>
<pre class="example">
.
├── ansible-cloud
│   ├── ansible.cfg
│   ├── inventory
│   └── README.md
└── terraform-cloud
    ├── example_code.py
    ├── index.html
    ├── readme.org
    └── terraform
</pre>
<ul class="org-ul">
<li>This structure is rigid as I may want to experiment getting outputs from Terraform into Ansible. But I don&rsquo;t think this is best practice (to be done locally) as Git checkouts/clones can vary by user. I think one solution is a Git submodule, or just using terraform <code>local-exec</code> to clone in place, but as mentioned in <a href="https://www.terraform.io/docs/language/resources/provisioners/local-exec.html">local-exec provisioner documentation</a> it is a last resort.</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-org42ff60f" class="outline-2">
<h2 id="org42ff60f"><span class="section-number-2">2</span> Install Terraform&#xa0;&#xa0;&#xa0;<span class="tag"><span class="terraform">terraform</span>&#xa0;<span class="install">install</span></span></h2>
<div class="outline-text-2" id="text-2">
<p>
<a href="https://www.terraform.io/downloads.html">https://www.terraform.io/downloads.html</a>
</p>
</div>
</div>
<div id="outline-container-org49485aa" class="outline-2">
<h2 id="org49485aa"><span class="section-number-2">3</span> Install Packer &#x2013; (Unused in this project, at this time)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="packer">packer</span>&#xa0;<span class="install">install</span></span></h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">curl</span> -fsSL https://apt.releases.hashicorp.com/gpg | <span style="color: #ECBE7B;">sudo</span> apt-key add -
<span style="color: #ECBE7B;">sudo</span> apt-add-repository <span style="color: #98be65;">"deb [arch=amd64] https://apt.releases.hashicorp.com </span><span style="color: #51afef; font-weight: bold;">$(</span><span style="color: #51afef; font-weight: bold;">lsb_release</span><span style="color: #51afef; font-weight: bold;"> -cs)</span><span style="color: #98be65;"> main"</span>
<span style="color: #ECBE7B;">sudo</span> apt-get update &amp;&amp; <span style="color: #ECBE7B;">sudo</span> apt-get install packer
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf7ac4ff" class="outline-2">
<h2 id="orgf7ac4ff"><span class="section-number-2">4</span> Configure AWS&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aws">aws</span></span></h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>Register account: <a href="https://portal.aws.amazon.com/gp/aws/developer/registration/index.html">https://portal.aws.amazon.com/gp/aws/developer/registration/index.html</a></li>
</ul>
</div>
<div id="outline-container-orgfc102e1" class="outline-3">
<h3 id="orgfc102e1"><span class="section-number-3">4.1</span> Setup AWS CLI&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cli">cli</span>&#xa0;<span class="install">install</span></span></h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-linux.html">https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-linux.html</a></li>
</ul>
</div>
</div>
<div id="outline-container-org4255609" class="outline-3">
<h3 id="org4255609"><span class="section-number-3">4.2</span> Use AWS CLI&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cli">cli</span></span></h3>
</div>
<div id="outline-container--configure-aws-create-iam-user-and-policies-" class="outline-3">
<h3 id="-configure-aws-create-iam-user-and-policies-"><span class="section-number-3">4.3</span> Create IAM User and Policies&#xa0;&#xa0;&#xa0;<span class="tag"><span class="iam">iam</span></span></h3>
<div class="outline-text-3" id="text--configure-aws-create-iam-user-and-policies-">
<ul class="org-ul">
<li>IAM: <a href="https://console.aws.amazon.com/iam/home">https://console.aws.amazon.com/iam/home</a></li>
<li>Polcies: <a href="https://console.aws.amazon.com/iamv2/home?#/policiesC">https://console.aws.amazon.com/iamv2/home?#/policiesC</a></li>
<li>IAM User: <a href="https://console.aws.amazon.com/iam/home#/users$new?step=details">https://console.aws.amazon.com/iam/home#/users$new?step=details</a>
<ul class="org-ul">
<li>programmatic (non-console)</li>
<li>attach existing policy</li>
</ul></li>
<li><p>
Add user to <code>/.aws/credentials</code> as a profile:
</p>
<pre class="example">
 [default]
 aws_access_key=&lt;your_key&gt;
 aws_secret_access_key=&lt;your_key&gt;

 [tf_user]
 aws_access_key=&lt;your_key&gt;
 aws_secret_access_key=&lt;your_key&gt;
</pre></li>
<li>Add root user as default, or create IAM admin:
<a href="https://console.aws.amazon.com/iam/home?region=us-east-1#/security_credentials$access_key">https://console.aws.amazon.com/iam/home?region=us-east-1#/security_credentials$access_key</a></li>
</ul>
</div>
<div id="outline-container-org680318c" class="outline-4">
<h4 id="org680318c"><span class="section-number-4">4.3.1</span> IAM Terraform User <span class="underline">start</span>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="policy">policy</span></span></h4>
<div class="outline-text-4" id="text-4-3-1">
<p>
<a href="./terraform/policies/terraform_user.json">./terraform/policies/terraform_user.json</a>
</p>
<ul class="org-ul">
<li>this is very much a WIP, and some of these are <b>wide</b> open, such as IAM while working through issues.</li>
<li>I am splitting this up so that each terraform module used get&rsquo;s it&rsquo;s IAM actions in the same bullet point/section.</li>
<li>See <a href="#-iam-terraform-user--end--">IAM Terraform User <span class="underline">end</span></a></li>
</ul>
<div class="org-src-container">
<pre class="src src-json">{
  <span style="color: #51afef;">"Version"</span>: "<span style="color: #da8548; font-weight: bold;">2012</span>-<span style="color: #da8548; font-weight: bold;">10</span>-<span style="color: #da8548; font-weight: bold;">17</span>",
  <span style="color: #51afef;">"Statement"</span>: [
    {
      <span style="color: #51afef;">"Sid"</span>: <span style="color: #98be65;">"CustomPolicyForACGAWSTFCourse"</span>,
      <span style="color: #51afef;">"Action"</span>: [
        <span style="color: #98be65;">"ec2:Describe*"</span>,
        <span style="color: #98be65;">"ec2:Get*"</span>,
        <span style="color: #98be65;">"ec2:AcceptVpcPeeringConnection"</span>,
        <span style="color: #98be65;">"ec2:AttachInternetGateway"</span>,
        <span style="color: #98be65;">"ec2:AssociateRouteTable"</span>,
        <span style="color: #98be65;">"ec2:AssociateIamInstanceProfile"</span>,
        <span style="color: #98be65;">"ec2:AuthorizeSecurityGroupEgress"</span>,
        <span style="color: #98be65;">"ec2:AuthorizeSecurityGroupIngress"</span>,
        <span style="color: #98be65;">"ec2:CreateInternetGateway"</span>,
        <span style="color: #98be65;">"ec2:CreateNetworkAcl"</span>,
        <span style="color: #98be65;">"ec2:CreateNetworkAclEntry"</span>,
        <span style="color: #98be65;">"ec2:CreateRoute"</span>,
        <span style="color: #98be65;">"ec2:CreateRouteTable"</span>,
        <span style="color: #98be65;">"ec2:CreateSecurityGroup"</span>,
        <span style="color: #98be65;">"ec2:CreateSubnet"</span>,
        <span style="color: #98be65;">"ec2:CreateTags"</span>,
        <span style="color: #98be65;">"ec2:CreateVpc"</span>,
        <span style="color: #98be65;">"ec2:CreateVpcPeeringConnection"</span>,
        <span style="color: #98be65;">"ec2:DeleteNetworkAcl"</span>,
        <span style="color: #98be65;">"ec2:DeleteNetworkAclEntry"</span>,
        <span style="color: #98be65;">"ec2:DeleteRoute"</span>,
        <span style="color: #98be65;">"ec2:DeleteRouteTable"</span>,
        <span style="color: #98be65;">"ec2:DeleteSecurityGroup"</span>,
        <span style="color: #98be65;">"ec2:DeleteSubnet"</span>,
        <span style="color: #98be65;">"ec2:DeleteTags"</span>,
        <span style="color: #98be65;">"ec2:DeleteVpc"</span>,
        <span style="color: #98be65;">"ec2:DeleteVpcPeeringConnection"</span>,
        <span style="color: #98be65;">"ec2:DetachInternetGateway"</span>,
        <span style="color: #98be65;">"ec2:DisassociateRouteTable"</span>,
        <span style="color: #98be65;">"ec2:DisassociateSubnetCidrBlock"</span>,
        <span style="color: #98be65;">"ec2:CreateKeyPair"</span>,
        <span style="color: #98be65;">"ec2:DeleteKeyPair"</span>,
        <span style="color: #98be65;">"ec2:DeleteInternetGateway"</span>,
        <span style="color: #98be65;">"ec2:ImportKeyPair"</span>,
        <span style="color: #98be65;">"ec2:ModifySubnetAttribute"</span>,
        <span style="color: #98be65;">"ec2:ModifyVpcAttribute"</span>,
        <span style="color: #98be65;">"ec2:ModifyVpcPeeringConnectionOptions"</span>,
        <span style="color: #98be65;">"ec2:RejectVpcPeeringConnection"</span>,
        <span style="color: #98be65;">"ec2:ReplaceNetworkAclAssociation"</span>,
        <span style="color: #98be65;">"ec2:ReplaceNetworkAclEntry"</span>,
        <span style="color: #98be65;">"ec2:ReplaceRoute"</span>,
        <span style="color: #98be65;">"ec2:ReplaceRouteTableAssociation"</span>,
        <span style="color: #98be65;">"ec2:RevokeSecurityGroupEgress"</span>,
        <span style="color: #98be65;">"ec2:RevokeSecurityGroupIngress"</span>,
        <span style="color: #98be65;">"ec2:RunInstances"</span>,
        <span style="color: #98be65;">"ec2:TerminateInstances"</span>,
        <span style="color: #98be65;">"ec2:UpdateSecurityGroupRuleDescriptionsEgress"</span>,
        <span style="color: #98be65;">"ec2:UpdateSecurityGroupRuleDescriptionsIngress"</span>,
        <span style="color: #98be65;">"acm:*"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:AddListenerCertificates"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:AddTags"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:CreateListener"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:CreateLoadBalancer"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:CreateRule"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:CreateTargetGroup"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:DeleteListener"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:DeleteLoadBalancer"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:DeleteRule"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:DeleteTargetGroup"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:DeregisterTargets"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:DescribeListenerCertificates"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:DescribeListeners"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:DescribeLoadBalancerAttributes"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:DescribeLoadBalancers"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:DescribeRules"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:DescribeSSLPolicies"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:DescribeTags"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:DescribeTargetGroupAttributes"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:DescribeTargetGroups"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:DescribeTargetHealth"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:ModifyListener"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:ModifyLoadBalancerAttributes"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:ModifyRule"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:ModifyTargetGroup"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:ModifyTargetGroupAttributes"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:RegisterTargets"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:RemoveListenerCertificates"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:RemoveTags"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:SetSecurityGroups"</span>,
        <span style="color: #98be65;">"elasticloadbalancing:SetSubnets"</span>,
        <span style="color: #98be65;">"route53:Get*"</span>,
        <span style="color: #98be65;">"route53:List*"</span>,
        <span style="color: #98be65;">"route53:ChangeResourceRecordSets"</span>,
        <span style="color: #98be65;">"ssm:Describe*"</span>,
        <span style="color: #98be65;">"ssm:GetParameter"</span>,
        <span style="color: #98be65;">"ssm:GetParameters"</span>,
        <span style="color: #98be65;">"ssm:GetParametersByPath"</span>,
        <span style="color: #98be65;">"s3:CreateBucket"</span>,
        <span style="color: #98be65;">"s3:*"</span>,
        <span style="color: #98be65;">"s3:DeleteBucket"</span>,
        <span style="color: #98be65;">"s3:DeleteObject"</span>,
        <span style="color: #98be65;">"s3:GetBucketLocation"</span>,
        <span style="color: #98be65;">"s3:GetObject"</span>,
        <span style="color: #98be65;">"s3:HeadBucket"</span>,
        <span style="color: #98be65;">"s3:ListBucket"</span>,
        <span style="color: #98be65;">"iam:*"</span>,
        <span style="color: #98be65;">"s3:PutObject"</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org40af7ed" class="outline-2">
<h2 id="org40af7ed"><span class="section-number-2">5</span> Configure Terraform Cloud&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cloud">cloud</span>&#xa0;<span class="terraform_cloud">terraform_cloud</span></span></h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>Regsiter account: <a href="https://app.terraform.io/signup/account?utm_source=terraform_io&amp;utm_content=terraform_cloud_top_nav">https://app.terraform.io/signup/account?utm_source=terraform_io&amp;utm_content=terraform_cloud_top_nav</a></li>
<li>Create an organization</li>
<li>Create a Workspace from VCS Repository, ex: <a href="https://github.com">https://github.com</a></li>
<li>Create a token and save in <code>~/.terraform.d/credentials.tfrc.json</code>
<ul class="org-ul">
<li><a href="https://app.terraform.io/app/settings/tokens">https://app.terraform.io/app/settings/tokens</a></li>
</ul></li>
<li>Add access keys to Terraform Cloud
<ul class="org-ul">
<li><a href="https://app.terraform.io/app/">https://app.terraform.io/app/</a>&lt;organization&gt;/workspaces/&lt;workspace&gt;/variables</li>
</ul></li>
<li>Initialize your environment <code>terraform init</code></li>
<li>Configure Terraform Cloud to plan and apply upon check-in
<ul class="org-ul">
<li><a href="https://app.terraform.io/app/">https://app.terraform.io/app/</a>&lt;your<sub>org</sub>&gt;/workspaces/&lt;your<sub>workspace</sub>&gt;/settings/general</li>
</ul></li>
<li>setup a backend remote pointing to your org/workspace</li>
</ul>
</div>
<div id="outline-container-orga0c1132" class="outline-3">
<h3 id="orga0c1132"><span class="section-number-3">5.1</span> <a href="./terraform/backend.tf">./terraform/backend.tf</a></h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">
<pre class="src src-json">terraform {
  backend <span style="color: #98be65;">"remote"</span> {
    organization = <span style="color: #98be65;">"hilgendorfdotme"</span>
    workspaces {
      name = <span style="color: #98be65;">"tf-ans"</span>
    }
  }
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container--create-infrastructure-with-terraform-" class="outline-2">
<h2 id="-create-infrastructure-with-terraform-"><span class="section-number-2">6</span> Create Infrastructure with Terraform&#xa0;&#xa0;&#xa0;<span class="tag"><span class="terraform">terraform</span>&#xa0;<span class="iac">iac</span></span></h2>
<div class="outline-text-2" id="text--create-infrastructure-with-terraform-">
</div>
<div id="outline-container-org0c02e78" class="outline-3">
<h3 id="org0c02e78"><span class="section-number-3">6.1</span> Configure Providers</h3>
<div class="outline-text-3" id="text-6-1">
</div>
<div id="outline-container-org63c9229" class="outline-4">
<h4 id="org63c9229"><span class="section-number-4">6.1.1</span> <a href="./terraform/providers.tf">./terraform/providers.tf</a></h4>
<div class="outline-text-4" id="text-6-1-1">
<div class="org-src-container">
<pre class="src src-json">provider <span style="color: #98be65;">"aws"</span> {
  #profile = var.profile
  region = var.region-master
  alias  = <span style="color: #98be65;">"region-master"</span>
}

provider <span style="color: #98be65;">"aws"</span> {
  #profile = var.profile
  region = var.region-worker
  alias  = <span style="color: #98be65;">"region-worker"</span>
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org22a2152" class="outline-3">
<h3 id="org22a2152"><span class="section-number-3">6.2</span> Create variables&#xa0;&#xa0;&#xa0;<span class="tag"><span class="variables">variables</span></span></h3>
<div class="outline-text-3" id="text-6-2">
<ul class="org-ul">
<li>Input variables serve as parameters for a Terraform module, allowing aspects of the module to be customized without altering the module&rsquo;s own source code, and allowing modules to be shared between different configurations.
<ul class="org-ul">
<li><a href="https://www.terraform.io/docs/language/values/variables.html">https://www.terraform.io/docs/language/values/variables.html</a></li>
</ul></li>
</ul>
</div>
<div id="outline-container-orge3cb1c9" class="outline-4">
<h4 id="orge3cb1c9"><span class="section-number-4">6.2.1</span> <a href="./terraform/variables.tf">./terraform/variables.tf</a></h4>
<div class="outline-text-4" id="text-6-2-1">
<ul class="org-ul">
<li>profile and default user</li>
<li>two regions
<ul class="org-ul">
<li>a master region (us-east-1)</li>
<li>a worker region (us-west-2)</li>
</ul></li>
<li>external ip (yours)</li>
<li>workers count (how many instances to create)</li>
<li>instance type when deploying EC2</li>
<li>a URL for our Ansible repo so we can clone it</li>
<li>set IAM policy for EC2 Full access, this will be used for Ansible <a href="#org187efda">Dynamic Inventory</a></li>
</ul>
<div class="org-src-container">
<pre class="src src-json">variable <span style="color: #98be65;">"profile"</span> {
  type    = string
  default = <span style="color: #98be65;">"tf_user"</span>
}
variable <span style="color: #98be65;">"region-master"</span> {
  type    = string
  default = "us-east-<span style="color: #da8548; font-weight: bold;">1</span>"
}
variable <span style="color: #98be65;">"region-worker"</span> {
  type    = string
  default = "us-west-<span style="color: #da8548; font-weight: bold;">2</span>"
}
variable <span style="color: #98be65;">"test"</span> {
  type    = string
  default = <span style="color: #98be65;">"catheadbiscuit"</span>
}
#Replace with &lt;YOUR_EXTERNAL_IP&gt;  https://ipv<span style="color: #a9a1e1;">4</span>.icanhazip.com
variable <span style="color: #98be65;">"external_ip"</span> {
  type    = string
  default = "<span style="color: #da8548; font-weight: bold;">0.0</span>.<span style="color: #da8548; font-weight: bold;">0.0</span>/<span style="color: #da8548; font-weight: bold;">0</span>"
}
variable <span style="color: #98be65;">"workers-count"</span> {
  type    = number
  default = <span style="color: #da8548; font-weight: bold;">1</span>
}
variable <span style="color: #98be65;">"instance-type"</span> {
  type    = string
  default = <span style="color: #98be65;">"t3.micro"</span>
}
variable <span style="color: #98be65;">"ansible-git"</span> {
  type    = string
  default = <span style="color: #98be65;">"https://github.com/edhilgendorf/ansible-cloud.git"</span>
}
variable <span style="color: #98be65;">"iam_policy_ec2_full_arn"</span> {
  description = <span style="color: #98be65;">"IAM Policy for full EC2"</span>
  type = string
  default = <span style="color: #98be65;">"arn:aws:iam::aws:policy/AmazonEC2FullAccess"</span>
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org9998023" class="outline-3">
<h3 id="org9998023"><span class="section-number-3">6.3</span> Create a network&#xa0;&#xa0;&#xa0;<span class="tag"><span class="network">network</span></span></h3>
<div class="outline-text-3" id="text-6-3">
</div>
<div id="outline-container-org7263c86" class="outline-4">
<h4 id="org7263c86"><span class="section-number-4">6.3.1</span> Create VPCs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="vpc">vpc</span></span></h4>
<div class="outline-text-4" id="text-6-3-1">
<ul class="org-ul">
<li>A virtual network dedicated to your AWS account.
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html">https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html</a></li>
</ul></li>
</ul>
</div>
<ol class="org-ol">
<li><a id="orgcec0b79"></a><a href="./terraform/network.tf">./terraform/network.tf</a><br />
<div class="outline-text-5" id="text-6-3-1-1">
<ul class="org-ul">
<li>VPCs
<ul class="org-ul">
<li><b>vpc<sub>master</sub></b>
<ul class="org-ul">
<li>deploy in us-east-1</li>
<li>give network 10.0.0.0/16</li>
<li>enable dns and hostnames</li>
<li>tag this as <code>master-vpc-devops</code></li>
</ul></li>
<li><b>vpc<sub>master</sub><sub>oregon</sub></b>
<ul class="org-ul">
<li>deploy in us-west-2</li>
<li>give network 192.168.0.0/16</li>
<li>enable dns and hostnames</li>
<li>tag as <code>worker-vpc-devops</code></li>
</ul></li>
</ul></li>
<li>Variables come from: <a href="#org22a2152">Create variables</a></li>
</ul>
<div class="org-src-container">
<pre class="src src-json">#Create VPC in us-east-<span style="color: #da8548; font-weight: bold;">1</span>
resource <span style="color: #98be65;">"aws_vpc"</span> <span style="color: #98be65;">"vpc_master"</span> {
  provider             = aws.region-master
  cidr_block           = "<span style="color: #da8548; font-weight: bold;">10.0</span>.<span style="color: #da8548; font-weight: bold;">0.0</span>/<span style="color: #da8548; font-weight: bold;">16</span>"
  enable_dns_support   = <span style="color: #a9a1e1;">true</span>
  enable_dns_hostnames = <span style="color: #a9a1e1;">true</span>
  tags = {
    Name = <span style="color: #98be65;">"master-vpc-devops"</span>
  }
}
#Create VPC in us-west-<span style="color: #da8548; font-weight: bold;">2</span>
resource <span style="color: #98be65;">"aws_vpc"</span> <span style="color: #98be65;">"vpc_master_oregon"</span> {
  provider             = aws.region-worker
  cidr_block           = "<span style="color: #da8548; font-weight: bold;">192.168</span>.<span style="color: #da8548; font-weight: bold;">0.0</span>/<span style="color: #da8548; font-weight: bold;">16</span>"
  enable_dns_support   = <span style="color: #a9a1e1;">true</span>
  enable_dns_hostnames = <span style="color: #a9a1e1;">true</span>
  tags = {
    Name = <span style="color: #98be65;">"worker-vpc-devops"</span>
  }
}
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org40f1aa6" class="outline-4">
<h4 id="org40f1aa6"><span class="section-number-4">6.3.2</span> Create IGWs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="igw">igw</span></span></h4>
<div class="outline-text-4" id="text-6-3-2">
<ul class="org-ul">
<li>An internet gateway is a horizontally scaled, redundant, and highly available VPC component that allows communication between your VPC and the internet.
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Internet_Gateway.html">https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Internet_Gateway.html</a></li>
</ul></li>
</ul>
</div>
<ol class="org-ol">
<li><a id="org1721921"></a><a href="./terraform/network.tf">./terraform/network.tf</a><br />
<div class="outline-text-5" id="text-6-3-2-1">
<ul class="org-ul">
<li>create an internet gateway in each VPC, which reside in different availability zones (us-east-1 and us-west-2)</li>
</ul>
<div class="org-src-container">
<pre class="src src-json">#Create IGW in us-east-<span style="color: #da8548; font-weight: bold;">1</span>
resource <span style="color: #98be65;">"aws_internet_gateway"</span> <span style="color: #98be65;">"igw"</span> {
  provider = aws.region-master
  vpc_id   = aws_vpc.vpc_master.id
}
#Create IGW in us-west-<span style="color: #da8548; font-weight: bold;">2</span>
resource <span style="color: #98be65;">"aws_internet_gateway"</span> <span style="color: #98be65;">"igw-oregon"</span> {
  provider = aws.region-worker
  vpc_id   = aws_vpc.vpc_master_oregon.id
}
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgd6580f6" class="outline-4">
<h4 id="orgd6580f6"><span class="section-number-4">6.3.3</span> Provide Data&#xa0;&#xa0;&#xa0;<span class="tag"><span class="data">data</span></span></h4>
<div class="outline-text-4" id="text-6-3-3">
<ul class="org-ul">
<li>Data sources allow Terraform use information defined outside of Terraform, defined by another separate Terraform configuration, or modified by functions.
<ul class="org-ul">
<li><a href="https://www.terraform.io/docs/language/data-sources/index.html">https://www.terraform.io/docs/language/data-sources/index.html</a></li>
</ul></li>
</ul>
</div>
<ol class="org-ol">
<li><a id="org2bd4efe"></a><a href="./terraform/network.tf">./terraform/network.tf</a><br />
<div class="outline-text-5" id="text-6-3-3-1">
<ul class="org-ul">
<li>get <code>aws_availability_zones</code> that are in <code>state: available</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-json">#get all available AZs in VPC for master
data <span style="color: #98be65;">"aws_availability_zones"</span> <span style="color: #98be65;">"azs"</span> {
  provider = aws.region-master
  state    = <span style="color: #98be65;">"available"</span>
}
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org5c46a18" class="outline-4">
<h4 id="org5c46a18"><span class="section-number-4">6.3.4</span> Create Subnets in our VPCs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="subnet">subnet</span></span></h4>
<div class="outline-text-4" id="text-6-3-4">
<ul class="org-ul">
<li>When you create a VPC, you must specify a range of IPv4 addresses for the VPC in the form of a Classless Inter-Domain Routing (CIDR) block; for example, 10.0.0.0/16. This is the primary CIDR block for your VPC. For more information about CIDR notation, see RFC 4632.
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html">https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html</a></li>
</ul></li>
</ul>
</div>
<ol class="org-ol">
<li><a id="org1cafdc3"></a><a href="./terraform/network.tf">./terraform/network.tf</a><br />
<div class="outline-text-5" id="text-6-3-4-1">
<ul class="org-ul">
<li>two subnets in the master VPC defined in <a href="#org7263c86">Create VPCs</a>.
<ul class="org-ul">
<li><code>10.0.1.0/24</code></li>
<li><code>10.0.2.0/24</code></li>
</ul></li>
<li>one subnet in the worker VPC defined in  <a href="#org7263c86">Create VPCs</a>.
<ul class="org-ul">
<li><code>192.168.1.0/24</code></li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-json">  #create subnet #<span style="color: #da8548; font-weight: bold;">1</span> in us-east-<span style="color: #da8548; font-weight: bold;">1</span>
  resource <span style="color: #98be65;">"aws_subnet"</span> <span style="color: #98be65;">"subnet_1"</span> {
    provider          = aws.region-master
    availability_zone = element(data.aws_availability_zones.azs.names, <span style="color: #da8548; font-weight: bold;">0</span>)
    vpc_id            = aws_vpc.vpc_master.id
    cidr_block        = "<span style="color: #da8548; font-weight: bold;">10.0</span>.<span style="color: #da8548; font-weight: bold;">1.0</span>/<span style="color: #da8548; font-weight: bold;">24</span>"
  }
  #create subnet #<span style="color: #da8548; font-weight: bold;">2</span> in us-east-<span style="color: #da8548; font-weight: bold;">1</span>
  resource <span style="color: #98be65;">"aws_subnet"</span> <span style="color: #98be65;">"subnet_2"</span> {
    provider          = aws.region-master
    availability_zone = element(data.aws_availability_zones.azs.names, <span style="color: #da8548; font-weight: bold;">1</span>)
    vpc_id            = aws_vpc.vpc_master.id
    cidr_block        = "<span style="color: #da8548; font-weight: bold;">10.0</span>.<span style="color: #da8548; font-weight: bold;">2.0</span>/<span style="color: #da8548; font-weight: bold;">24</span>"
  }
  #create subnet #<span style="color: #da8548; font-weight: bold;">1</span> in us-west-<span style="color: #da8548; font-weight: bold;">2</span>
  resource <span style="color: #98be65;">"aws_subnet"</span> <span style="color: #98be65;">"subnet_1_oregon"</span> {
    provider   = aws.region-worker
    vpc_id     = aws_vpc.vpc_master_oregon.id
    cidr_block = "<span style="color: #da8548; font-weight: bold;">192.168</span>.<span style="color: #da8548; font-weight: bold;">1.0</span>/<span style="color: #da8548; font-weight: bold;">24</span>"
  }
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org3e3ef58" class="outline-4">
<h4 id="org3e3ef58"><span class="section-number-4">6.3.5</span> Create Peering between VPCs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="peering">peering</span></span></h4>
<div class="outline-text-4" id="text-6-3-5">
<ul class="org-ul">
<li>A VPC peering connection is a networking connection between two VPCs that enables you to route traffic between them using private IPv4 addresses or IPv6 addresses.
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/vpc/latest/peering/what-is-vpc-peering.html">https://docs.aws.amazon.com/vpc/latest/peering/what-is-vpc-peering.html</a></li>
</ul></li>
</ul>
</div>
<ol class="org-ol">
<li><a id="org4ede279"></a><a href="./terraform/network.tf">./terraform/network.tf</a><br />
<div class="outline-text-5" id="text-6-3-5-1">
<ul class="org-ul">
<li>Create a peering connection request from the master VPC.</li>
<li>Create a peering connection acceptor from the worker VPC.</li>
</ul>
<div class="org-src-container">
<pre class="src src-json">#Initiate Peering connection request from us-east-<span style="color: #da8548; font-weight: bold;">1</span>
resource <span style="color: #98be65;">"aws_vpc_peering_connection"</span> <span style="color: #98be65;">"useast1-uswest2"</span> {
  provider    = aws.region-master
  peer_vpc_id = aws_vpc.vpc_master_oregon.id
  vpc_id      = aws_vpc.vpc_master.id
  peer_region = var.region-worker

}
#Accept VPC peering request in us-west-<span style="color: #da8548; font-weight: bold;">2</span> from us-east-<span style="color: #da8548; font-weight: bold;">1</span>
resource <span style="color: #98be65;">"aws_vpc_peering_connection_accepter"</span> <span style="color: #98be65;">"accept_peering"</span> {
  provider                  = aws.region-worker
  vpc_peering_connection_id = aws_vpc_peering_connection.useast<span style="color: #a9a1e1;">1</span>-uswest<span style="color: #a9a1e1;">2</span>.id
  auto_accept               = <span style="color: #a9a1e1;">true</span>
}
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org6c1efe2" class="outline-4">
<h4 id="org6c1efe2"><span class="section-number-4">6.3.6</span> Create Routing in and between VPCs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="route">route</span>&#xa0;<span class="vpc">vpc</span></span></h4>
<div class="outline-text-4" id="text-6-3-6">
<ul class="org-ul">
<li>A route table contains a set of rules, called routes, that are used to determine where network traffic from your subnet or gateway is directed.
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Route_Tables.html">https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Route_Tables.html</a></li>
</ul></li>
</ul>
</div>
<ol class="org-ol">
<li><a id="org837e9c3"></a><a href="./terraform/network.tf">./terraform/network.tf</a><br />
<div class="outline-text-5" id="text-6-3-6-1">
<ul class="org-ul">
<li>create a routing table for the master VPC
<ul class="org-ul">
<li>to internet via <code>aws_internet_gateway.igw.id</code></li>
<li>to the worker VPC Peering Connection created in:  <a href="#org3e3ef58">Create Peering between VPCs</a></li>
</ul></li>
<li>replace default route of the master VPC with the routing table created above</li>
<li>create routing table for worker VPC
<ul class="org-ul">
<li>to internet via <code>aws_internet_gateway.igw.id</code></li>
<li>to the master VPC Peering Connection created in:  <a href="#org3e3ef58">Create Peering between VPCs</a></li>
</ul></li>
<li>replace default route of the worker VPC with the routing table created above</li>
</ul>
<div class="org-src-container">
<pre class="src src-json">#Create route table in us-east-<span style="color: #da8548; font-weight: bold;">1</span>
resource <span style="color: #98be65;">"aws_route_table"</span> <span style="color: #98be65;">"internet_route"</span> {
  provider = aws.region-master
  vpc_id   = aws_vpc.vpc_master.id
  route {
    cidr_block = "<span style="color: #da8548; font-weight: bold;">0.0</span>.<span style="color: #da8548; font-weight: bold;">0.0</span>/<span style="color: #da8548; font-weight: bold;">0</span>"
    gateway_id = aws_internet_gateway.igw.id
  }
  route {
    cidr_block                = "<span style="color: #da8548; font-weight: bold;">192.168</span>.<span style="color: #da8548; font-weight: bold;">1.0</span>/<span style="color: #da8548; font-weight: bold;">24</span>"
    vpc_peering_connection_id = aws_vpc_peering_connection.useast<span style="color: #a9a1e1;">1</span>-uswest<span style="color: #a9a1e1;">2</span>.id
  }
  lifecycle {
    ignore_changes = all
  }
  tags = {
    Name = <span style="color: #98be65;">"Master-Region-RT"</span>
  }
}
#Overwrite default route table of VPC(Master) with our route table entries
resource <span style="color: #98be65;">"aws_main_route_table_association"</span> <span style="color: #98be65;">"set-master-default-rt-assoc"</span> {
  provider       = aws.region-master
  vpc_id         = aws_vpc.vpc_master.id
  route_table_id = aws_route_table.internet_route.id
}
#Create route table in us-west-<span style="color: #da8548; font-weight: bold;">2</span>
resource <span style="color: #98be65;">"aws_route_table"</span> <span style="color: #98be65;">"internet_route_oregon"</span> {
  provider = aws.region-worker
  vpc_id   = aws_vpc.vpc_master_oregon.id
  route {
    cidr_block = "<span style="color: #da8548; font-weight: bold;">0.0</span>.<span style="color: #da8548; font-weight: bold;">0.0</span>/<span style="color: #da8548; font-weight: bold;">0</span>"
    gateway_id = aws_internet_gateway.igw-oregon.id
  }
  route {
    cidr_block                = "<span style="color: #da8548; font-weight: bold;">10.0</span>.<span style="color: #da8548; font-weight: bold;">1.0</span>/<span style="color: #da8548; font-weight: bold;">24</span>"
    vpc_peering_connection_id = aws_vpc_peering_connection.useast<span style="color: #a9a1e1;">1</span>-uswest<span style="color: #a9a1e1;">2</span>.id
  }
  lifecycle {
    ignore_changes = all
  }
  tags = {
    Name = <span style="color: #98be65;">"Worker-Region-RT"</span>
  }
}
#Overwrite default route table of VPC(Worker) with our route table entries
resource <span style="color: #98be65;">"aws_main_route_table_association"</span> <span style="color: #98be65;">"set-worker-default-rt-assoc"</span> {
  provider       = aws.region-worker
  vpc_id         = aws_vpc.vpc_master_oregon.id
  route_table_id = aws_route_table.internet_route_oregon.id
}
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org02f0909" class="outline-4">
<h4 id="org02f0909"><span class="section-number-4">6.3.7</span> Create Security Groups&#xa0;&#xa0;&#xa0;<span class="tag"><span class="security_groups">security_groups</span></span></h4>
<div class="outline-text-4" id="text-6-3-7">
<ul class="org-ul">
<li>A security group acts as a virtual firewall for your instance to control inbound and outbound traffic.
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html">https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html</a></li>
</ul></li>
</ul>
</div>
<ol class="org-ol">
<li><a id="orgbefcc85"></a><a href="./terraform/security_groups.tf">./terraform/security_groups.tf</a><br />
<div class="outline-text-5" id="text-6-3-7-1">
<ul class="org-ul">
<li>create a SG for the: TODO Application Load Balancer TODO
<ul class="org-ul">
<li>allow in from 80/443 web ports.</li>
<li>allow out anywhere for ephemeral ports.</li>
</ul></li>
<li>create a security group for devops in VPC Master
<ul class="org-ul">
<li>allow in from 80/443 web ports.</li>
<li>allow out anywhere for ephemeral ports.</li>
<li>allow ssh from port 22 from our home IP</li>
<li>allow in from us-west-2 (worker) subnet created in  <a href="#org5c46a18">Create Subnets in our VPCs</a></li>
</ul></li>
<li>create a security group for devops in VPC worker
<ul class="org-ul">
<li>allow in from 80/443 web ports.</li>
<li>allow out anywhere for ephemeral ports.</li>
<li>allow ssh from port 22 from our home IP</li>
<li>allow in from us-east-1 (master) subnet created in  <a href="#org5c46a18">Create Subnets in our VPCs</a></li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-json">#Create SG for LB, only TCP/<span style="color: #da8548; font-weight: bold;">80</span>,TCP/<span style="color: #da8548; font-weight: bold;">443</span> and outbound access
resource <span style="color: #98be65;">"aws_security_group"</span> <span style="color: #98be65;">"lb-sg"</span> {
  provider    = aws.region-master
  name        = <span style="color: #98be65;">"lb-sg"</span>
  description = "Allow <span style="color: #da8548; font-weight: bold;">443</span> and traffic to devops SG"
  vpc_id      = aws_vpc.vpc_master.id
  ingress {
    description = "Allow <span style="color: #da8548; font-weight: bold;">443</span> from anywhere"
    from_port   = <span style="color: #da8548; font-weight: bold;">443</span>
    to_port     = <span style="color: #da8548; font-weight: bold;">443</span>
    protocol    = <span style="color: #98be65;">"tcp"</span>
    cidr_blocks = ["<span style="color: #da8548; font-weight: bold;">0.0</span>.<span style="color: #da8548; font-weight: bold;">0.0</span>/<span style="color: #da8548; font-weight: bold;">0</span>"]
  }
  ingress {
    description = "Allow <span style="color: #da8548; font-weight: bold;">80</span> from anywhere for redirection"
    from_port   = <span style="color: #da8548; font-weight: bold;">80</span>
    to_port     = <span style="color: #da8548; font-weight: bold;">80</span>
    protocol    = <span style="color: #98be65;">"tcp"</span>
    cidr_blocks = ["<span style="color: #da8548; font-weight: bold;">0.0</span>.<span style="color: #da8548; font-weight: bold;">0.0</span>/<span style="color: #da8548; font-weight: bold;">0</span>"]
  }
  egress {
    from_port   = <span style="color: #da8548; font-weight: bold;">0</span>
    to_port     = <span style="color: #da8548; font-weight: bold;">0</span>
    protocol    = "-<span style="color: #da8548; font-weight: bold;">1</span>"
    cidr_blocks = ["<span style="color: #da8548; font-weight: bold;">0.0</span>.<span style="color: #da8548; font-weight: bold;">0.0</span>/<span style="color: #da8548; font-weight: bold;">0</span>"]
  }
}
#Create SG for allowing TCP/<span style="color: #da8548; font-weight: bold;">8080</span> from * and TCP/<span style="color: #da8548; font-weight: bold;">22</span> from your IP in us-east-<span style="color: #da8548; font-weight: bold;">1</span>
resource <span style="color: #98be65;">"aws_security_group"</span> <span style="color: #98be65;">"devops-sg"</span> {
  provider    = aws.region-master
  name        = <span style="color: #98be65;">"devops-sg"</span>
  description = "Allow TCP/<span style="color: #da8548; font-weight: bold;">8080</span> &amp; TCP/<span style="color: #da8548; font-weight: bold;">22</span>"
  vpc_id      = aws_vpc.vpc_master.id
  ingress {
    description = "Allow <span style="color: #da8548; font-weight: bold;">22</span> from our public IP"
    from_port   = <span style="color: #da8548; font-weight: bold;">22</span>
    to_port     = <span style="color: #da8548; font-weight: bold;">22</span>
    protocol    = <span style="color: #98be65;">"tcp"</span>
    cidr_blocks = [var.external_ip]
  }
  ingress {
    description     = "allow anyone on port <span style="color: #da8548; font-weight: bold;">8080</span>"
    from_port       = <span style="color: #da8548; font-weight: bold;">8080</span>
    to_port         = <span style="color: #da8548; font-weight: bold;">8080</span>
    protocol        = <span style="color: #98be65;">"tcp"</span>
    security_groups = [aws_security_group.lb-sg.id]
  }
  ingress {
    description = "allow traffic from us-west-<span style="color: #da8548; font-weight: bold;">2</span>"
    from_port   = <span style="color: #da8548; font-weight: bold;">0</span>
    to_port     = <span style="color: #da8548; font-weight: bold;">0</span>
    protocol    = "-<span style="color: #da8548; font-weight: bold;">1</span>"
    cidr_blocks = ["<span style="color: #da8548; font-weight: bold;">192.168</span>.<span style="color: #da8548; font-weight: bold;">1.0</span>/<span style="color: #da8548; font-weight: bold;">24</span>"]
  }
  egress {
    from_port   = <span style="color: #da8548; font-weight: bold;">0</span>
    to_port     = <span style="color: #da8548; font-weight: bold;">0</span>
    protocol    = "-<span style="color: #da8548; font-weight: bold;">1</span>"
    cidr_blocks = ["<span style="color: #da8548; font-weight: bold;">0.0</span>.<span style="color: #da8548; font-weight: bold;">0.0</span>/<span style="color: #da8548; font-weight: bold;">0</span>"]
  }
}
#Create SG for allowing TCP/<span style="color: #da8548; font-weight: bold;">22</span> from your IP in us-west-<span style="color: #da8548; font-weight: bold;">2</span>
resource <span style="color: #98be65;">"aws_security_group"</span> <span style="color: #98be65;">"devops-sg-oregon"</span> {
  provider = aws.region-worker

  name        = <span style="color: #98be65;">"devops-sg-oregon"</span>
  description = "Allow TCP/<span style="color: #da8548; font-weight: bold;">8080</span> &amp; TCP/<span style="color: #da8548; font-weight: bold;">22</span>"
  vpc_id      = aws_vpc.vpc_master_oregon.id
  ingress {
    description = "Allow <span style="color: #da8548; font-weight: bold;">22</span> from our public IP"
    from_port   = <span style="color: #da8548; font-weight: bold;">22</span>
    to_port     = <span style="color: #da8548; font-weight: bold;">22</span>
    protocol    = <span style="color: #98be65;">"tcp"</span>
    cidr_blocks = [var.external_ip]
  }
  ingress {
    description = "Allow traffic from us-east-<span style="color: #da8548; font-weight: bold;">1</span>"
    from_port   = <span style="color: #da8548; font-weight: bold;">0</span>
    to_port     = <span style="color: #da8548; font-weight: bold;">0</span>
    protocol    = "-<span style="color: #da8548; font-weight: bold;">1</span>"
    cidr_blocks = ["<span style="color: #da8548; font-weight: bold;">10.0</span>.<span style="color: #da8548; font-weight: bold;">1.0</span>/<span style="color: #da8548; font-weight: bold;">24</span>"]
  }
  egress {
    from_port   = <span style="color: #da8548; font-weight: bold;">0</span>
    to_port     = <span style="color: #da8548; font-weight: bold;">0</span>
    protocol    = "-<span style="color: #da8548; font-weight: bold;">1</span>"
    cidr_blocks = ["<span style="color: #da8548; font-weight: bold;">0.0</span>.<span style="color: #da8548; font-weight: bold;">0.0</span>/<span style="color: #da8548; font-weight: bold;">0</span>"]
  }
}
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-orge72d2a5" class="outline-3">
<h3 id="orge72d2a5"><span class="section-number-3">6.4</span> Create IAM Role for EC2 Access&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ec2">ec2</span>&#xa0;<span class="iam">iam</span></span></h3>
<div class="outline-text-3" id="text-6-4">
</div>
<div id="outline-container-org9d855b8" class="outline-4">
<h4 id="org9d855b8"><span class="section-number-4">6.4.1</span> <a href="./terraform/iam.tf">./terraform/iam.tf</a>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aws_iam_role">aws_iam_role</span></span></h4>
<div class="outline-text-4" id="text-6-4-1">
<div class="org-src-container">
<pre class="src src-json">resource <span style="color: #98be65;">"aws_iam_role"</span> <span style="color: #98be65;">"test_role"</span> {
  name = <span style="color: #98be65;">"test_role"</span>
  provider                    = aws.region-master
  assume_role_policy = &lt;&lt;EOF
{
  <span style="color: #51afef;">"Version"</span>: "<span style="color: #da8548; font-weight: bold;">2012</span>-<span style="color: #da8548; font-weight: bold;">10</span>-<span style="color: #da8548; font-weight: bold;">17</span>",
  <span style="color: #51afef;">"Statement"</span>: [
    {
      <span style="color: #51afef;">"Action"</span>: <span style="color: #98be65;">"sts:AssumeRole"</span>,
      <span style="color: #51afef;">"Principal"</span>: {
        <span style="color: #51afef;">"Service"</span>: <span style="color: #98be65;">"ec2.amazonaws.com"</span>
      },
      <span style="color: #51afef;">"Effect"</span>: <span style="color: #98be65;">"Allow"</span>,
      <span style="color: #51afef;">"Sid"</span>: <span style="color: #98be65;">""</span>
    }
  ]
}
EOF
  tags = {
      tag-key = <span style="color: #98be65;">"tag-value"</span>
  }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb73ba76" class="outline-4">
<h4 id="orgb73ba76"><span class="section-number-4">6.4.2</span> <a href="./terraform/iam.tf">./terraform/iam.tf</a>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aws_iam_instance_profile">aws_iam_instance_profile</span></span></h4>
<div class="outline-text-4" id="text-6-4-2">
<div class="org-src-container">
<pre class="src src-json">resource <span style="color: #98be65;">"aws_iam_instance_profile"</span> <span style="color: #98be65;">"test_profile"</span> {
  name = <span style="color: #98be65;">"test_profile"</span>
 provider                    = aws.region-master
  role = <span style="color: #98be65;">"${aws_iam_role.test_role.name}"</span>
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org0a4a01f" class="outline-4">
<h4 id="org0a4a01f"><span class="section-number-4">6.4.3</span> <a href="./terraform/iam.tf">./terraform/iam.tf</a>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aws_iam_role_policy">aws_iam_role_policy</span></span></h4>
<div class="outline-text-4" id="text-6-4-3">
<div class="org-src-container">
<pre class="src src-json">resource <span style="color: #98be65;">"aws_iam_role_policy"</span> <span style="color: #98be65;">"test_policy"</span> {
  name = <span style="color: #98be65;">"test_policy"</span>
provider                    = aws.region-master
  role = <span style="color: #98be65;">"${aws_iam_role.test_role.id}"</span>

  policy = &lt;&lt;EOF
{
  <span style="color: #51afef;">"Version"</span>: "<span style="color: #da8548; font-weight: bold;">2012</span>-<span style="color: #da8548; font-weight: bold;">10</span>-<span style="color: #da8548; font-weight: bold;">17</span>",
  <span style="color: #51afef;">"Statement"</span>: [
    {
      <span style="color: #51afef;">"Action"</span>: [
        <span style="color: #98be65;">"s3:*"</span>,
        <span style="color: #98be65;">"ec2:*"</span>
      ],
      <span style="color: #51afef;">"Effect"</span>: <span style="color: #98be65;">"Allow"</span>,
      <span style="color: #51afef;">"Resource"</span>: <span style="color: #98be65;">"*"</span>
    }
  ]
}
EOF
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orge00f99d" class="outline-3">
<h3 id="orge00f99d"><span class="section-number-3">6.5</span> Create Instances</h3>
<div class="outline-text-3" id="text-6-5">
</div>
<div id="outline-container-org58d0f3b" class="outline-4">
<h4 id="org58d0f3b"><span class="section-number-4">6.5.1</span> Get AMIs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ami">ami</span>&#xa0;<span class="vm">vm</span></span></h4>
<div class="outline-text-4" id="text-6-5-1">
<ul class="org-ul">
<li>An Amazon Machine Image (AMI) provides the information required to launch an instance.
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html</a></li>
</ul></li>
</ul>
</div>
<ol class="org-ol">
<li><a id="org0c9d2a9"></a><a href="./terraform/instances.tf">./terraform/instances.tf</a><br />
<div class="outline-text-5" id="text-6-5-1-1">
<ul class="org-ul">
<li>data
<ul class="org-ul">
<li>get the AMI names for the latest Amazon Linux AMI</li>
<li>store this as linuxAmi and linuxAmiOregon</li>
<li>can later be accessed with: <code>data.aws_ssm_parameter.linuxAmi.value</code></li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-json">#Get Linux AMI ID using SSM Parameter endpoint in us-east-<span style="color: #da8548; font-weight: bold;">1</span>
data <span style="color: #98be65;">"aws_ssm_parameter"</span> <span style="color: #98be65;">"linuxAmi"</span> {
  provider = aws.region-master
  name     = <span style="color: #98be65;">"/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"</span>
}
#Get Linux AMI ID using SSM Parameter endpoint in us-west-<span style="color: #da8548; font-weight: bold;">2</span>
data <span style="color: #98be65;">"aws_ssm_parameter"</span> <span style="color: #98be65;">"linuxAmiOregon"</span> {
  provider = aws.region-worker
  name     = <span style="color: #98be65;">"/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"</span>
}
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgfc3d56d" class="outline-4">
<h4 id="orgfc3d56d"><span class="section-number-4">6.5.2</span> Set cloud-init Scripts</h4>
<div class="outline-text-4" id="text-6-5-2">
</div>
<ol class="org-ol">
<li><a id="org36d5dae"></a><a href="./terraform/instances.tf">./terraform/instances.tf</a><br />
<div class="outline-text-5" id="text-6-5-2-1">
<ul class="org-ul">
<li>data
<ul class="org-ul">
<li>store cloud-init as data to pass to EC2 for boostrapping</li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-json">data <span style="color: #98be65;">"template_file"</span> <span style="color: #98be65;">"user_data"</span> {
  template = file(<span style="color: #98be65;">"./scripts/cloud-init.yaml"</span>)
}
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org72efbb0" class="outline-4">
<h4 id="org72efbb0"><span class="section-number-4">6.5.3</span> Configure SSH keypairs for AMI VMs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="keypair">keypair</span></span></h4>
<div class="outline-text-4" id="text-6-5-3">
<ul class="org-ul">
<li>A key pair, consisting of a public key and a private key, is a set of security credentials that you use to prove your identity when connecting to an Amazon EC2 instance. Amazon EC2 stores the public key on your instance, and you store the private key. For Linux instances, the private key allows you to securely SSH into your instance. Anyone who possesses your private key can connect to your instances, so it&rsquo;s important that you store your private key in a secure place.
<ul class="org-ul">
<li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html">EC2 Keypairs</a></li>
</ul></li>
</ul>
</div>
<ol class="org-ol">
<li><a id="org90dae70"></a><a href="./terraform/instances.tf">./terraform/instances.tf</a><br />
<div class="outline-text-5" id="text-6-5-3-1">
<ul class="org-ul">
<li>assign keypairs for each region from <a href="./terraform/ssh/id_rsa.pub">./terraform/ssh/id_rsa.pub</a></li>
</ul>
<div class="org-src-container">
<pre class="src src-json">#Create key-pair for logging into EC<span style="color: #a9a1e1;">2</span> in us-east-<span style="color: #da8548; font-weight: bold;">1</span>
resource <span style="color: #98be65;">"aws_key_pair"</span> <span style="color: #98be65;">"master-key"</span> {
  provider = aws.region-master
  key_name = <span style="color: #98be65;">"devops"</span>
  public_key = file(<span style="color: #98be65;">"ssh/id_rsa.pub"</span>)
}
#Create key-pair for logging into EC<span style="color: #a9a1e1;">2</span> in us-west-<span style="color: #da8548; font-weight: bold;">2</span>
resource <span style="color: #98be65;">"aws_key_pair"</span> <span style="color: #98be65;">"worker-key"</span> {
  provider = aws.region-worker
  key_name = <span style="color: #98be65;">"devops"</span>
  public_key = file(<span style="color: #98be65;">"ssh/id_rsa.pub"</span>)
}
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org0947e7f" class="outline-4">
<h4 id="org0947e7f"><span class="section-number-4">6.5.4</span> Create EC2 Instances&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ec2">ec2</span></span></h4>
<div class="outline-text-4" id="text-6-5-4">
<ul class="org-ul">
<li>Amazon Elastic Compute Cloud (Amazon EC2) is a web service that provides secure, resizable compute capacity in the cloud. It is designed to make web-scale cloud computing easier for developers.
<ul class="org-ul">
<li><a href="https://aws.amazon.com/ec2/?ec2-whats-new.sort-by=item.additionalFields.postDateTime&amp;ec2-whats-new.sort-order=desc">AWS EC2</a></li>
</ul></li>
</ul>
</div>
<ol class="org-ol">
<li><a id="orgb9b78b9"></a><a href="./terraform/instances.tf">./terraform/instances.tf</a><br />
<div class="outline-text-5" id="text-6-5-4-1">
<div class="org-src-container">
<pre class="src src-json">#Create and bootstrap EC<span style="color: #a9a1e1;">2</span> in us-east-<span style="color: #da8548; font-weight: bold;">1</span>
resource <span style="color: #98be65;">"aws_instance"</span> <span style="color: #98be65;">"devops-master"</span> {
  provider                    = aws.region-master
  ami                         = data.aws_ssm_parameter.linuxAmi.value
  instance_type               = var.instance-type
  key_name                    = aws_key_pair.master-key.key_name
  associate_public_ip_address = <span style="color: #a9a1e1;">true</span>
  vpc_security_group_ids      = [aws_security_group.devops-sg.id]
  subnet_id                   = aws_subnet.subnet_<span style="color: #a9a1e1;">1</span>.id
  user_data                   = data.template_file.user_data.rendered
  iam_instance_profile = <span style="color: #98be65;">"${aws_iam_instance_profile.test_profile.name}"</span>
  tags = {
    Name = <span style="color: #98be65;">"devops_master_tf"</span>
  }
  depends_on = [aws_main_route_table_association.set-master-default-rt-assoc]
}
#Create EC<span style="color: #a9a1e1;">2</span> in us-west-<span style="color: #da8548; font-weight: bold;">2</span>
resource <span style="color: #98be65;">"aws_instance"</span> <span style="color: #98be65;">"devops-worker-oregon"</span> {
  provider                    = aws.region-worker
  count                       = var.workers-count
  ami                         = data.aws_ssm_parameter.linuxAmiOregon.value
  instance_type               = var.instance-type
  key_name                    = aws_key_pair.worker-key.key_name
  associate_public_ip_address = <span style="color: #a9a1e1;">true</span>
  vpc_security_group_ids      = [aws_security_group.devops-sg-oregon.id]
  subnet_id                   = aws_subnet.subnet_<span style="color: #a9a1e1;">1</span>_oregon.id
  tags = {
    Name = join(<span style="color: #98be65;">"_"</span>, [<span style="color: #98be65;">"devops_worker_tf"</span>, count.index + <span style="color: #da8548; font-weight: bold;">1</span>])
  }
  depends_on = [aws_main_route_table_association.set-worker-default-rt-assoc, aws_instance.devops-master]
}
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container--create-infrastructure-with-terraform-s3-" class="outline-3">
<h3 id="-create-infrastructure-with-terraform-s3-"><span class="section-number-3">6.6</span> S3&#xa0;&#xa0;&#xa0;<span class="tag"><span class="s3">s3</span></span></h3>
<div class="outline-text-3" id="text--create-infrastructure-with-terraform-s3-">
<ul class="org-ul">
<li>Attaching an S3 bucket to hold  miscellaneous data that may be needed during/post provisioning.</li>
</ul>
</div>
<div id="outline-container-org38c889a" class="outline-4">
<h4 id="org38c889a"><span class="section-number-4">6.6.1</span> <a href="./terraform/s3.tf">./terraform/s3.tf</a>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aws_s3">aws_s3</span></span></h4>
<div class="outline-text-4" id="text-6-6-1">
<div class="org-src-container">
<pre class="src src-json">resource <span style="color: #98be65;">"aws_s3_bucket"</span> <span style="color: #98be65;">"misc-data"</span> {
  provider  = aws.region-master
  bucket    = <span style="color: #98be65;">"hilgendorf-misc-data"</span>
  acl       = <span style="color: #98be65;">"private"</span>

  tags = {
    Name        = <span style="color: #98be65;">"misc data"</span>
  }
}
</pre>
</div>
<ul class="org-ul">
<li>Currently getting error when creating, seemingly unable to add/list tags, commenting out until further investigation.
<ul class="org-ul">
<li><p>
error:
Error: error updating S3 Bucket (hilgendorf-misc-data) tags: error listing resource tags (hilgendorf-misc-data): AccessDenied: Access Denied status code: 403, request id: TR6J0XR2TT65SF3N, host id: 53e1UhXXF/V7BXwyudSim+1LG895eIc0dL2+5RDVA7lRdjmxzuzyKDb7eCGCgFlGGEMNHGOBwsM=
with aws<sub>s3</sub><sub>bucket.misc</sub>-data
on s3.tf line 1, in resource &ldquo;aws<sub>s3</sub><sub>bucket</sub>&rdquo; &ldquo;misc-data&rdquo;:
</p>

<p>
resource &ldquo;aws<sub>s3</sub><sub>bucket</sub>&rdquo; &ldquo;misc-data&rdquo; {
</p></li>
<li>Issue was due to <b>IAM</b>, policy updated <a href="#-configure-aws-create-iam-user-and-policies-">Create IAM User and Policies</a> but need to further refine. This worked after giving <code>"s3:*"</code> to <code>terraform-user</code></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org5cbfaa9" class="outline-3">
<h3 id="org5cbfaa9"><span class="section-number-3">6.7</span> Create EFS&#xa0;&#xa0;&#xa0;<span class="tag"><span class="efs">efs</span></span></h3>
<div class="outline-text-3" id="text-6-7">
</div>
<div id="outline-container-org54d1ffc" class="outline-4">
<h4 id="org54d1ffc"><span class="section-number-4">6.7.1</span> <a href="./terraform/efs.tf">./terraform/efs.tf</a></h4>
<div class="outline-text-4" id="text-6-7-1">
<div class="org-src-container">
<pre class="src src-json">resource <span style="color: #98be65;">"aws_efs_file_system"</span> <span style="color: #98be65;">"dev"</span> {
  creation_token = <span style="color: #98be65;">"dev-volume"</span>
  provider  = aws.region-master
  tags = {
    Name = <span style="color: #98be65;">"keys"</span>
  }
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container--create-infrastructure-with-terraform-ecs-for-awx-" class="outline-3">
<h3 id="-create-infrastructure-with-terraform-ecs-for-awx-"><span class="section-number-3">6.8</span> ECS for AWX&#xa0;&#xa0;&#xa0;<span class="tag"><span class="awx">awx</span>&#xa0;<span class="ecs">ecs</span></span></h3>
<div class="outline-text-3" id="text--create-infrastructure-with-terraform-ecs-for-awx-">
<ul class="org-ul">
<li>An Amazon ECS service allows you to run and maintain a specified number of instances of a task definition simultaneously in an Amazon ECS cluster. If any of your tasks should fail or stop for any reason, the Amazon ECS service scheduler launches another instance of your task definition to replace it in order to maintain the desired number of tasks in the service.</li>
</ul>
<p>
:CUSTOM<sub>ID</sub>: -create-infrastructure-with-terraform-ecs-for-awx-
</p>
</div>
<div id="outline-container-org78580b2" class="outline-4">
<h4 id="org78580b2"><span class="section-number-4">6.8.1</span> <a href="./terraform/ecs.tf">./terraform/ecs.tf</a></h4>
<div class="outline-text-4" id="text-6-8-1">
<div class="org-src-container">
<pre class="src src-json">
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org3bec491" class="outline-3">
<h3 id="org3bec491"><span class="section-number-3">6.9</span> Create Outputs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="output">output</span></span></h3>
<div class="outline-text-3" id="text-6-9">
</div>
<div id="outline-container-orgddeaf1d" class="outline-4">
<h4 id="orgddeaf1d"><span class="section-number-4">6.9.1</span> <a href="./terraform/outputs.tf">./terraform/outputs.tf</a>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="outputs">outputs</span></span></h4>
<div class="outline-text-4" id="text-6-9-1">
<div class="org-src-container">
<pre class="src src-json">output <span style="color: #98be65;">"Devops-Main-Node-Public-IP"</span> {
  value = aws_instance.devops-master.public_ip
}

output <span style="color: #98be65;">"Devops-Worker-Public-IPs"</span> {
  value = {
    for instance in aws_instance.devops-worker-oregon :
    instance.id =&gt; instance.public_ip
  }
}
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org413d071" class="outline-2">
<h2 id="org413d071"><span class="section-number-2">7</span> Bootstrap EC2 with cloud-init&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cloud_init">cloud_init</span></span></h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li><a href="https://cloudinit.readthedocs.io/en/latest/">https://cloudinit.readthedocs.io/en/latest/</a></li>
<li><a href="https://cloudinit.readthedocs.io/en/latest/topics/examples.html">https://cloudinit.readthedocs.io/en/latest/topics/examples.html</a></li>
</ul>
</div>
<div id="outline-container-orgd40da37" class="outline-3">
<h3 id="orgd40da37"><span class="section-number-3">7.1</span> <a href="./terraform/scripts/cloud-init.yaml">./terraform/scripts/cloud-init.yaml</a>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cloudinit">cloudinit</span>&#xa0;<span class="script">script</span></span></h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li>install software</li>
<li>create users</li>
<li>jenkins-master will also be ansible master</li>
<li>create ssh key</li>
<li>copy it to ec2-user known keys</li>
</ul>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #5B6268;">#</span><span style="color: #5B6268;">cloud-config</span>
<span style="color: #dcaeea;">package_update</span>: <span style="color: #a9a1e1;">true</span>
<span style="color: #dcaeea;">package_upgrade</span>: <span style="color: #a9a1e1;">true</span>
<span style="color: #dcaeea;">packages</span>:
  - awscli
  - tmux
  - ansible
  - git
  - python3
  - python3-pip
  - python-boto3
<span style="color: #dcaeea;">runcmd</span>:
  - aws --version
  - echo <span style="color: #98be65;">"cathead-biscuit"</span>
  - yum update -y
  - amazon-linux-extras install ansible2
  - ansible --version
  - git clone https://github.com/edhilgendorf/ansible-cloud.git
  - pip3 install boto3
  - sudo mkdir -p /opt/ansible/inventory
</pre>
</div>
</div>
</div>
<div id="outline-container-org1049a0d" class="outline-3">
<h3 id="org1049a0d"><span class="section-number-3">7.2</span> <a href="./terraform/scripts/cloud-init.yaml">./terraform/scripts/cloud-init.yaml</a>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="cloudinit">cloudinit</span>&#xa0;<span class="script">script</span></span></h3>
<div class="outline-text-3" id="text-7-2">
<ul class="org-ul">
<li>We need to get public SSH keys synced from master. Current plan is to add IAM (<a href="#orge72d2a5">Create IAM Role for EC2 Access</a>) roles to the EC2 instances so they can add and download keys via AWS CLI (<a href="#org4255609">Use AWS CLI</a>)</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org40fa15b" class="outline-2">
<h2 id="org40fa15b"><span class="section-number-2">8</span> Configuration Management with Ansible&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ansible">ansible</span></span></h2>
<div class="outline-text-2" id="text-8">
<ul class="org-ul">
<li>This will be focused on a new repository: <a href="https://github.com/edhilgendorf/ansible-cloud.git">ansible-cloud</a></li>
<li>From here we will provision all agent EC2 instances created in <a href="#-create-infrastructure-with-terraform-">Create Infrastructure with Terraform</a> with Ansible, starting with Jenkins</li>
</ul>
</div>
<div id="outline-container-orgc902780" class="outline-3">
<h3 id="orgc902780"><span class="section-number-3">8.1</span> <del>Getting AWS Credentials to Ansible</del> This is best configured by attaching a role to the EC2 instance, done here: <a href="#orge72d2a5">Create IAM Role for EC2 Access</a></h3>
<div class="outline-text-3" id="text-8-1">
<ul class="org-ul">
<li>Local AWS access via <a href="https://aws.amazon.com/cli/">AWS CLI</a> must be configured prior to this point, so we are going to leverage those credentials to get them into place on the EC2 server so we are able to build and maintain our <a href="#org187efda">Dynamic Inventory</a>.</li>
<li>To do this we will need to run a local script, <b>after</b> Terraform provisioning is complete.</li>
</ul>
</div>
<div id="outline-container-orgbc4eb52" class="outline-4">
<h4 id="orgbc4eb52"><span class="section-number-4">8.1.1</span> <a href="./terraform/sync-aws-creds.sh">./terraform/sync-aws-creds.sh</a></h4>
<div class="outline-text-4" id="text-8-1-1">
<div class="org-src-container">
<pre class="src src-json">rsync -vaP ~/.aws/credentials ec<span style="color: #a9a1e1;">2</span>-user@$(terraform output -json | jq  -r '.<span style="color: #98be65;">"Jenkins-Main-Node-Public-IP"</span>.<span style="color: #98be65;">"value"</span>'):/tmp/credentials
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org187efda" class="outline-3">
<h3 id="org187efda"><span class="section-number-3">8.2</span> Dynamic Inventory&#xa0;&#xa0;&#xa0;<span class="tag"><span class="dynamic_inventory">dynamic_inventory</span></span></h3>
<div class="outline-text-3" id="text-8-2">
<p>
<a href="https://aws.amazon.com/blogs/apn/getting-started-with-ansible-and-dynamic-amazon-ec2-inventory-management/">https://aws.amazon.com/blogs/apn/getting-started-with-ansible-and-dynamic-amazon-ec2-inventory-management/</a>
</p>
</div>
<div id="outline-container-orga0eb763" class="outline-4">
<h4 id="orga0eb763"><span class="section-number-4">8.2.1</span> <a href="../ansible-cloud/ansible.cfg">../ansible-cloud/ansible.cfg</a></h4>
<div class="outline-text-4" id="text-8-2-1">
<ul class="org-ul">
<li>enable the aws<sub>ec2</sub> plugin</li>
<li>set the inventory file to our dynamic inventory</li>
<li>set remote<sub>user</sub></li>
</ul>
<p>
:header-args: :tangle ../ansible-cloud/ansible.cfg
</p>
<pre class="example">
[inventory]
enable_plugins = aws_ec2
[defaults]
inventory = /ansible-cloud/ansible-inventory.yml
</pre>
</div>
</div>
<div id="outline-container-org0ab71f4" class="outline-4">
<h4 id="org0ab71f4"><span class="section-number-4">8.2.2</span> <a href="../ansible-cloud/aws_ec2.yml">../ansible-cloud/aws_ec2.yml</a></h4>
<div class="outline-text-4" id="text-8-2-2">
<div class="org-src-container">
<pre class="src src-yml">---
plugin: aws_ec2
keyed_groups:
  - key: tags
    prefix: tag
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container--iam-terraform-user--end--" class="outline-2">
<h2 id="-iam-terraform-user--end--"><span class="section-number-2">9</span> IAM Terraform User <span class="underline">end</span>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="policy_end">policy_end</span></span></h2>
<div class="outline-text-2" id="text--iam-terraform-user--end--">
<p>
<a href="./terraform/policies/terraform_user.json">./terraform/policies/terraform_user.json</a>
</p>
<div class="org-src-container">
<pre class="src src-json">      ],
      <span style="color: #51afef;">"Effect"</span>: <span style="color: #98be65;">"Allow"</span>,
      <span style="color: #51afef;">"Resource"</span>: <span style="color: #98be65;">"*"</span>
    }
  ]
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org8e84a1a" class="outline-2">
<h2 id="org8e84a1a"><span class="section-number-2">10</span> Useful Commands</h2>
<div class="outline-text-2" id="text-10">
<ul class="org-ul">
<li><code>taint</code>: taint a resource to be replaced. This might be useful to retest a cloud-init script without recreating all of your infrastructure.
<ul class="org-ul">
<li>ex: <code>terraform taint aws_instance.jenkins-master</code></li>
</ul></li>
<li><p>
execute a remote command to your EC2 instance
</p>
<div class="org-src-container">
<pre class="src src-sh">ssh -o <span style="color: #dcaeea;">StrictHostKeyChecking</span>=no ec2-user@$<span style="color: #51afef;">(</span><span style="color: #51afef; font-weight: bold;">terraform</span> output -json | jq  -r <span style="color: #98be65;">'."Devops-Main-Node-Public-IP"."value"'</span><span style="color: #51afef;">)</span> <span style="color: #98be65;">"</span><span style="color: #98be65;">sudo</span><span style="color: #98be65;"> </span><span style="color: #98be65;">grep</span><span style="color: #98be65;"> 'cathead' /var/log/cloud-init-output.log"</span>
</pre>
</div></li>
<li><p>
ssh to your EC2 instance
</p>
<div class="org-src-container">
<pre class="src src-sh">ssh -o <span style="color: #dcaeea;">StrictHostKeyChecking</span>=no ec2-user@$<span style="color: #51afef;">(</span><span style="color: #51afef; font-weight: bold;">terraform</span> output -json | jq  -r <span style="color: #98be65;">'."Devops-Main-Node-Public-IP"."value"'</span><span style="color: #51afef;">)</span>
</pre>
</div></li>
<li><p>
get IP of an instance
</p>
<div class="org-src-container">
<pre class="src src-sh">terraform output -json | jq  -r <span style="color: #98be65;">'."Devops-Main-Node-Public-IP"."value"'</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org0aa524b" class="outline-2">
<h2 id="org0aa524b"><span class="section-number-2">11</span> Troubleshooting&#xa0;&#xa0;&#xa0;<span class="tag"><span class="troubleshooting">troubleshooting</span></span></h2>
<div class="outline-text-2" id="text-11">
</div>
<div id="outline-container-org1d729cc" class="outline-3">
<h3 id="org1d729cc"><span class="section-number-3">11.1</span> Encoded Messages&#xa0;&#xa0;&#xa0;<span class="tag"><span class="sts">sts</span>&#xa0;<span class="error">error</span></span></h3>
<div class="outline-text-3" id="text-11-1">
<ul class="org-ul">
<li>You can get an error message from AWS, in Terraform output in an encoded message. You can decode this on the CLI:
<ul class="org-ul">
<li>note: may need to apply <code>sts:</code> to your user&rsquo;s role to view the contents.</li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-bash">aws sts decode-authorization-message --encoded-message <span style="color: #98be65;">"&lt;your message here&gt;"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org9f96f6e" class="outline-3">
<h3 id="org9f96f6e"><span class="section-number-3">11.2</span> Unrelated Errors&#xa0;&#xa0;&#xa0;<span class="tag"><span class="error">error</span>&#xa0;<span class="region">region</span></span></h3>
<div class="outline-text-3" id="text-11-2">
<ul class="org-ul">
<li>While creating and attaching the EC2 Role&rsquo;s I was repeatedly getting an error saying &ldquo;Region must be set&rdquo;. I troubleshot this for days until I finally realized what was really happening &#x2013; The Terraform user (part of IAM) did not have permission to create IAM roles. After updating that role the region error disappeared. Always check your policy when adding new resources to ensure it is allowed and prevent wasting time.</li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: edward</p>
<p class="date">Created: 2021-10-12 Tue 16:12</p>
</div>
</body>
</html>
